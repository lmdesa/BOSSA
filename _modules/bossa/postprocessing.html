

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bossa.postprocessing &mdash; BOSSA 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BOSSA
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../bossa.html">bossa package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BOSSA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bossa.postprocessing</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bossa.postprocessing</h1><div class="highlight"><pre>
<span></span><span class="c1"># TODO: Add module documentation</span>
<span class="c1"># TODO: Complete documentation</span>


<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">inquirer</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tables</span> <span class="k">as</span> <span class="nn">tb</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1">#from pandarallel import pandarallel  # pandarallel breaks float types</span>
<span class="kn">import</span> <span class="nn">astropy.constants</span> <span class="k">as</span> <span class="nn">ct</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">WMAP9</span> <span class="k">as</span> <span class="n">cosmo</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">newton</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="c1">#import sys</span>
<span class="c1">#sys.path.append(&#39;..&#39;)</span>
<span class="kn">from</span> <span class="nn">bossa.sfh</span> <span class="kn">import</span> <span class="n">ChruslinskaSFRD</span>
<span class="kn">from</span> <span class="nn">bossa.imf</span> <span class="kn">import</span> <span class="n">Star</span><span class="p">,</span> <span class="n">IGIMF</span>
<span class="kn">from</span> <span class="nn">bossa.zams</span> <span class="kn">import</span> <span class="n">ZAMSSystemGenerator</span>
<span class="kn">from</span> <span class="nn">bossa.utils</span> <span class="kn">import</span> <span class="n">pull_snmass1</span><span class="p">,</span> <span class="n">pull_snmass2</span><span class="p">,</span> <span class="n">chirp_mass</span><span class="p">,</span> <span class="n">bintype</span><span class="p">,</span> <span class="n">mass_ratio</span><span class="p">,</span> <span class="n">create_logger</span><span class="p">,</span> \
    <span class="n">ZOH_to_FeH</span><span class="p">,</span> <span class="n">format_time</span>
<span class="kn">from</span> <span class="nn">bossa.constants</span> <span class="kn">import</span> <span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">COMPAS_PROC_OUTPUT_DIR_PATH</span><span class="p">,</span> <span class="n">COMPAS_WORK_PATH</span><span class="p">,</span> \
    <span class="n">BINARIES_CORRELATED_TABLE_PATH</span><span class="p">,</span> <span class="n">COMPAS_21XX_PROC_OUTPUT_DIR_PATH</span><span class="p">,</span> \
    <span class="n">COMPAS_12XX_PROC_OUTPUT_DIR_PATH</span><span class="p">,</span> <span class="n">COMPAS_21XX_GRIDS_PATH</span><span class="p">,</span> <span class="n">COMPAS_12XX_GRIDS_PATH</span><span class="p">,</span> \
    <span class="n">IGIMF_ZAMS_DIR_PATH</span><span class="p">,</span> <span class="n">COMPACT_OBJ_DIR_PATH</span>

<span class="n">CO_CODES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span>  <span class="c1"># HeWD, COWD, ONeMgWD, NS, BH</span>
<span class="n">PARQUET_SETTINGS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;engine&#39;</span><span class="p">:</span> <span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;compression&#39;</span><span class="p">:</span> <span class="s1">&#39;snappy&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;partition_cols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Mass_ZAMS1&#39;</span><span class="p">,</span> <span class="s1">&#39;LogP_ZAMS&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;use_threads&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<span class="n">MODULE_NAME</span> <span class="o">=</span> <span class="vm">__name__</span>


<div class="viewcode-block" id="COMPASOutputTrimmer">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.COMPASOutputTrimmer">[docs]</a>
<span class="k">class</span> <span class="nc">COMPASOutputTrimmer</span><span class="p">:</span>
    <span class="n">SNTAB_BASE_COLS_TOLOAD</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Mass(SN)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass(CP)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Unbound&#39;</span>
    <span class="p">]</span>
    <span class="n">SNTAB_PSR_COLS_TOLOAD</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Mass_Core@CO(SN)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_He_Core@CO(SN)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_CO_Core@CO(SN)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Fallback_Fraction(SN)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Kick_Magnitude(uK)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SystemicSpeed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Time&#39;</span>
    <span class="p">]</span>
    <span class="n">DCOTAB_COLS_TOLOAD</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Mass(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass(2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Coalescence_Time&#39;</span>
    <span class="p">]</span>
    <span class="n">SYSPARAMTAB_COLS_TOLOAD</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Initial_Mass(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Initial_Mass(2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_Ratio&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Stellar_Type(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Stellar_Type(2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Metallicity@ZAMS(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SemiMajorAxis@ZAMS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Eccentricity@ZAMS&#39;</span>
    <span class="p">]</span>
    <span class="n">PSRTAB_COLS_TOLOAD</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;MT_History&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass(2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pulsar_Mag_Field(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pulsar_Mag_Field(2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pulsar_Spin_Down(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pulsar_Spin_Down(2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pulsar_Spin_Freq(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pulsar_Spin_Freq(2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SemiMajorAxis&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Stellar_Type(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Stellar_Type(2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dT&#39;</span>
    <span class="p">]</span>
    <span class="n">BASE_COLS_TOSAVE</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Mass_ZAMS1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_ZAMS2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Stellar_Type1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Stellar_Type2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Metallicity_ZAMS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SemiMajorAxis_ZAMS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Eccentricity_ZAMS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SEED&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Chirp_Mass&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total_Mass_PostSN&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Total_Mass_ZAMS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_Ratio_PostSN&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LogP_ZAMS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Binary_Type&#39;</span>
    <span class="p">]</span>
    <span class="n">PSR_SN_DOUBLE_COLS_TOSAVE</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;PSR_SN_Mass_Core1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_Mass_Core2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_Mass_He_Core1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_Mass_He_Core2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_Mass_CO_Core1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_Mass_CO_Core2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_Fallback_Fraction1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_Fallback_Fraction2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_Kick_Magnitude1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_Kick_Magnitude2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_SystemicSpeed1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SN_SystemicSpeed2&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">PSR_DO_COLS_TOSAVE</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;PSR_DO_PreSN_Time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_DO_PreSN_Omega1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_DO_PreSN_Omega2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_DO_PreSN_Radius1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_DO_PreSN_Radius2&#39;</span>
    <span class="p">]</span>
    <span class="n">PSR_COLS_TOSAVE</span> <span class="o">=</span> <span class="n">BASE_COLS_TOSAVE</span> <span class="o">+</span> <span class="p">[</span>
        <span class="s1">&#39;PSR_MT_History&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_Mass1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_Mass2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_B1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_B2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_Pdot1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_Pdot2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_Omega1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_Omega2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_SemiMajorAxis&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_Type1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_Type2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_Time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PSR_dT&#39;</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">+</span> <span class="n">PSR_SN_DOUBLE_COLS_TOSAVE</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compas_output_option</span><span class="p">,</span> <span class="n">compas_sample_option</span><span class="p">,</span> <span class="n">only_load_dcos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_unbound_systems</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">save_pulsar_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parent_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compas_output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">COMPAS_WORK_PATH</span><span class="p">,</span> <span class="n">compas_output_option</span><span class="p">,</span> <span class="n">compas_sample_option</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trimmed_output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">COMPAS_PROC_OUTPUT_DIR_PATH</span><span class="p">,</span> <span class="n">compas_output_option</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.snappy.parquet&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">only_load_dcos</span> <span class="o">=</span> <span class="n">only_load_dcos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_unbound_systems</span> <span class="o">=</span> <span class="n">load_unbound_systems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_save_pulsar_columns</span><span class="p">(</span><span class="n">save_pulsar_columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_load</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_save</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_float32_cols</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logger</span><span class="p">(</span><span class="n">parent_logger</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">columns_to_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSR_COLS_TOSAVE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_COLS_TOSAVE</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_save</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">float32_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_float32_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_float32_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns_to_save</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s1">&#39;Stellar_Type1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Stellar_Type2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;SEED&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Binary_Type&#39;</span><span class="p">,</span>
                <span class="s1">&#39;PSR_MT_History&#39;</span><span class="p">,</span>
                <span class="s1">&#39;PSR_Type1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;PSR_Type2&#39;</span>
            <span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_float32_cols</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">columns_to_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_load</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_load_dcos</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SYSPARAMTAB_COLS_TOLOAD</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">DCOTAB_COLS_TOLOAD</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_load</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYSPARAMTAB_COLS_TOLOAD</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">DCOTAB_COLS_TOLOAD</span> <span class="o">+</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">SNTAB_BASE_COLS_TOLOAD</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">SNTAB_PSR_COLS_TOLOAD</span> <span class="o">+</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">PSRTAB_COLS_TOLOAD</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_load</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_load</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_load</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYSPARAMTAB_COLS_TOLOAD</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">DCOTAB_COLS_TOLOAD</span> <span class="o">+</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">SNTAB_BASE_COLS_TOLOAD</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns_to_load</span>

    <span class="k">def</span> <span class="nf">_set_save_pulsar_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_pulsar_columns</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">save_pulsar_columns</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_load_dcos</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;save_pulsar_columns was passed as True but only_load_dcos is also True.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">save_pulsar_columns</span>

    <span class="k">def</span> <span class="nf">_get_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_logger</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parent_logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loggername</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">loggername</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y_%H:%M:%S.log&#39;</span><span class="p">))</span>
            <span class="n">log_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">loggername</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loggername</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">loggername</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logger</span>

    <span class="k">def</span> <span class="nf">_set_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compas_output_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;COMPAS_Output*.h5&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_psr_sn_double_cols_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">no</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">no</span><span class="p">)</span>
        <span class="n">col_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Mass_Core@CO(SN)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;PSR_SN_Mass_Core</span><span class="si">{</span><span class="n">no</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Mass_He_Core@CO(SN)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;PSR_SN_Mass_He_Core</span><span class="si">{</span><span class="n">no</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Mass_CO_Core@CO(SN)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;PSR_SN_Mass_CO_Core</span><span class="si">{</span><span class="n">no</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">col_dict</span>

    <span class="k">def</span> <span class="nf">_get_df_from_hdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempting to load </span><span class="si">{</span><span class="n">hdf_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Columns to load: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">columns_to_load</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">empty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">hdf_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">tb</span><span class="o">.</span><span class="n">HDF5ExtError</span><span class="p">:</span>
            <span class="n">empty</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="n">hdf_path</span><span class="si">}</span><span class="s1"> empty&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sysparam_tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">BSE_System_Parameters</span>
            <span class="k">except</span> <span class="n">tb</span><span class="o">.</span><span class="n">NoSuchNodeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No BSE_System_Parameters table in </span><span class="si">{</span><span class="n">hdf_path</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No BSE_System_Parameters table in </span><span class="si">{</span><span class="n">hdf_path</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now loading </span><span class="si">{</span><span class="n">hdf_path</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="n">sort_sysparam_tab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sysparam_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)</span>
                <span class="n">full_seed_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sysparam_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)[</span><span class="n">sort_sysparam_tab</span><span class="p">]</span>
                <span class="n">samplesize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_seed_arr</span><span class="p">)</span>
                <span class="n">sample_metallicity</span> <span class="o">=</span> <span class="n">sysparam_tab</span><span class="p">[</span><span class="s1">&#39;Metallicity@ZAMS(1)&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sample_m1</span> <span class="o">=</span> <span class="n">sysparam_tab</span><span class="p">[</span><span class="s1">&#39;Initial_Mass(1)&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Table is valid, with M1 = </span><span class="si">{</span><span class="n">sample_m1</span><span class="si">}</span><span class="s1"> and Z = </span><span class="si">{</span><span class="n">sample_metallicity</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_load_dcos</span><span class="p">:</span>
                <span class="n">dcos_present</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">sns_present</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">psrs_present</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dco_tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">BSE_Double_Compact_Objects</span>
                <span class="k">except</span> <span class="n">tb</span><span class="o">.</span><span class="n">NoSuchNodeError</span><span class="p">:</span>
                    <span class="n">dcos_present</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">sns_present</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">psrs_present</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No DCOs produced.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sort_dco_tab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dco_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)</span>
                    <span class="n">dco_seed_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dco_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)[</span><span class="n">sort_dco_tab</span><span class="p">]</span>

                    <span class="n">sn_tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">BSE_Supernovae</span>
                    <span class="c1"># sort_sn_tab = np.argsort(sn_tab.SEED)</span>
                    <span class="n">sort_sn_tab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">sn_tab</span><span class="o">.</span><span class="n">Time</span><span class="p">,</span> <span class="n">sn_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">))</span>
                    <span class="n">sn_full_seed_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sn_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)[</span><span class="n">sort_sn_tab</span><span class="p">]</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unbound_systems</span><span class="p">:</span>
                        <span class="n">sn_partial_seed_arr</span> <span class="o">=</span> <span class="n">sn_full_seed_arr</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sn_bound_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sn_tab</span><span class="o">.</span><span class="n">Unbound</span><span class="p">)[</span><span class="n">sort_sn_tab</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
                        <span class="n">sn_partial_seed_arr</span> <span class="o">=</span> <span class="n">sn_full_seed_arr</span><span class="p">[</span><span class="n">sn_bound_mask</span><span class="p">]</span>
                    <span class="n">sn_bco_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sn_partial_seed_arr</span><span class="p">,</span> <span class="n">dco_seed_arr</span><span class="p">)</span>
                    <span class="n">sn_seed_arr</span> <span class="o">=</span> <span class="n">sn_partial_seed_arr</span><span class="p">[</span><span class="n">sn_bco_mask</span><span class="p">]</span>
                    <span class="n">first_sn_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">sn_full_seed_arr</span><span class="p">,</span>
                                                                       <span class="n">sn_seed_arr</span><span class="p">,</span>
                                                                       <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">second_sn_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">sn_full_seed_arr</span><span class="p">,</span>
                                                                        <span class="n">sn_seed_arr</span><span class="p">,</span>
                                                                        <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">psr_tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">BSE_Pulsar_Evolution</span>
                        <span class="k">except</span> <span class="n">tb</span><span class="o">.</span><span class="n">NoSuchNodeError</span><span class="p">:</span>
                            <span class="n">psrs_present</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No PSRs formed.&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sort_psr_tab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">psr_tab</span><span class="o">.</span><span class="n">Time</span><span class="p">,</span> <span class="n">psr_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">))</span>
                            <span class="n">psr_partial_seed_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psr_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)[</span><span class="n">sort_psr_tab</span><span class="p">]</span>
                            <span class="n">psr_bco_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">psr_partial_seed_arr</span><span class="p">,</span> <span class="n">dco_seed_arr</span><span class="p">)</span>
                            <span class="n">psr_seed_arr</span> <span class="o">=</span> <span class="n">psr_partial_seed_arr</span><span class="p">[</span><span class="n">psr_bco_mask</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">dcos_present</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">sns_present</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">psrs_present</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dco_tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">BSE_Double_Compact_Objects</span>
                <span class="k">except</span> <span class="n">tb</span><span class="o">.</span><span class="n">NoSuchNodeError</span><span class="p">:</span>
                    <span class="n">dcos_present</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No DCOs produced.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sort_dco_tab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dco_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)</span>
                    <span class="n">dco_seed_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dco_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)[</span><span class="n">sort_dco_tab</span><span class="p">]</span>

                    <span class="n">sn_tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">BSE_Supernovae</span>
                    <span class="c1"># sort_sn_tab = np.argsort(sn_tab.SEED)</span>
                    <span class="n">sort_sn_tab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">sn_tab</span><span class="o">.</span><span class="n">Time</span><span class="p">,</span> <span class="n">sn_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">))</span>
                    <span class="n">sn_full_seed_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sn_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)[</span><span class="n">sort_sn_tab</span><span class="p">]</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unbound_systems</span><span class="p">:</span>
                        <span class="n">sn_seed_arr</span> <span class="o">=</span> <span class="n">sn_full_seed_arr</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sn_bound_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sn_tab</span><span class="o">.</span><span class="n">Unbound</span><span class="p">)[</span><span class="n">sort_sn_tab</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
                        <span class="n">sn_seed_arr</span> <span class="o">=</span> <span class="n">sn_full_seed_arr</span><span class="p">[</span><span class="n">sn_bound_mask</span><span class="p">]</span>
                    <span class="n">first_sn_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">sn_full_seed_arr</span><span class="p">,</span>
                                                                       <span class="n">sn_seed_arr</span><span class="p">,</span>
                                                                       <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">second_sn_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">sn_full_seed_arr</span><span class="p">,</span>
                                                                        <span class="n">sn_seed_arr</span><span class="p">,</span>
                                                                        <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">dcos_present</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sn_tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">BSE_Supernovae</span>
                    <span class="k">except</span> <span class="n">tb</span><span class="o">.</span><span class="n">NoSuchNodeError</span><span class="p">:</span>
                        <span class="n">sns_present</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">psrs_present</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No SNs occurred.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># sort_sn_tab = np.argsort(sn_tab.SEED)</span>
                        <span class="n">sort_sn_tab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">sn_tab</span><span class="o">.</span><span class="n">Time</span><span class="p">,</span> <span class="n">sn_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">))</span>
                        <span class="n">sn_full_seed_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sn_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)[</span><span class="n">sort_sn_tab</span><span class="p">]</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unbound_systems</span><span class="p">:</span>
                            <span class="n">sn_seed_arr</span> <span class="o">=</span> <span class="n">sn_full_seed_arr</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sn_bound_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sn_tab</span><span class="o">.</span><span class="n">Unbound</span><span class="p">)[</span><span class="n">sort_sn_tab</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
                            <span class="n">sn_seed_arr</span> <span class="o">=</span> <span class="n">sn_full_seed_arr</span><span class="p">[</span><span class="n">sn_bound_mask</span><span class="p">]</span>
                        <span class="n">first_sn_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">sn_full_seed_arr</span><span class="p">,</span>
                                                                            <span class="n">sn_seed_arr</span><span class="p">,</span>
                                                                            <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">sns_present</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">psr_tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">BSE_Pulsar_Evolution</span>
                    <span class="k">except</span> <span class="n">tb</span><span class="o">.</span><span class="n">NoSuchNodeError</span><span class="p">:</span>
                        <span class="n">psrs_present</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No PSRs formed.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#sort_psr_tab = np.lexsort((psr_tab.Time, psr_tab.SEED))</span>
                        <span class="n">sort_psr_tab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">psr_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)</span>
                        <span class="n">psr_seed_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psr_tab</span><span class="o">.</span><span class="n">SEED</span><span class="p">)[</span><span class="n">sort_psr_tab</span><span class="p">]</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns_to_load</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span><span class="p">:</span>
                <span class="n">psr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns_to_load</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">psr_df</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading System Parameters table...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SYSPARAMTAB_COLS_TOLOAD</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sysparam_tab</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">sort_sysparam_tab</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dcos_present</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading Double Compact Objects table...&#39;</span><span class="p">)</span>
                <span class="n">fullsample_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">full_seed_arr</span><span class="p">,</span> <span class="n">dco_seed_arr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DCOTAB_COLS_TOLOAD</span><span class="p">:</span>
                    <span class="n">col_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="n">col_arr</span><span class="p">[</span><span class="n">fullsample_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dco_tab</span><span class="p">[</span><span class="n">col</span><span class="p">])[</span><span class="n">sort_dco_tab</span><span class="p">]</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_arr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DCOTAB_COLS_TOLOAD</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sns_present</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading Supernovae table...&#39;</span><span class="p">)</span>
                <span class="n">fullsample_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">full_seed_arr</span><span class="p">,</span> <span class="n">sn_seed_arr</span><span class="p">[</span><span class="n">first_sn_valid_indices</span><span class="p">])</span>
                <span class="c1"># print(&#39;fukllsampl&#39;, len(full_seed_arr), len(sn_seed_arr[second_sn_valid_indices]), len(fullsample_indices))</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SNTAB_BASE_COLS_TOLOAD</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s1">&#39;Unbound&#39;</span><span class="p">:</span>
                        <span class="c1"># print(&#39;Unbound&#39;, print(len(second_sn_valid_indices)), np.unique(np.array(sn_tab[col])[second_sn_valid_indices], return_counts=True))</span>
                        <span class="n">col_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">col_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="n">col_arr</span><span class="p">[</span><span class="n">fullsample_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sn_tab</span><span class="p">[</span><span class="n">col</span><span class="p">])[</span><span class="n">sort_sn_tab</span><span class="p">][</span><span class="n">first_sn_valid_indices</span><span class="p">]</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_arr</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading pulsar columns from the Supernovae table...&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">psrs_present</span><span class="p">:</span>
                        <span class="n">first_sn_fullsample_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">full_seed_arr</span><span class="p">,</span>
                                                                      <span class="n">sn_seed_arr</span><span class="p">[</span><span class="n">first_sn_valid_indices</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">dcos_present</span><span class="p">:</span>
                            <span class="n">second_sn_fullsample_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">full_seed_arr</span><span class="p">,</span>
                                                                           <span class="n">sn_seed_arr</span><span class="p">[</span><span class="n">second_sn_valid_indices</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SNTAB_PSR_COLS_TOLOAD</span><span class="p">:</span>
                            <span class="n">col_arr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                            <span class="n">col_arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                            <span class="n">col_arr1</span><span class="p">[</span><span class="n">first_sn_fullsample_indices</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sn_tab</span><span class="p">[</span><span class="n">col</span><span class="p">]))[</span><span class="n">sort_sn_tab</span><span class="p">][</span><span class="n">first_sn_valid_indices</span><span class="p">]</span>
                            <span class="n">psr_df</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_arr1</span>
                            <span class="k">if</span> <span class="n">dcos_present</span><span class="p">:</span>
                                <span class="n">col_arr2</span><span class="p">[</span><span class="n">second_sn_fullsample_indices</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sn_tab</span><span class="p">[</span><span class="n">col</span><span class="p">]))[</span><span class="n">sort_sn_tab</span><span class="p">][</span><span class="n">second_sn_valid_indices</span><span class="p">]</span>
                                <span class="n">psr_df</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_arr2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SNTAB_PSR_COLS_TOLOAD</span><span class="p">:</span>
                            <span class="n">psr_df</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">dcos_present</span><span class="p">:</span>
                                <span class="n">psr_df</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SNTAB_BASE_COLS_TOLOAD</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SNTAB_PSR_COLS_TOLOAD</span><span class="p">:</span>
                        <span class="n">psr_df</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dcos_present</span><span class="p">:</span>
                            <span class="n">psr_df</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">psr_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">psr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns_to_load</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">psrs_present</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading Pulsars table...&#39;</span><span class="p">)</span>
                    <span class="n">fullsample_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">full_seed_arr</span><span class="p">,</span> <span class="n">psr_seed_arr</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSRTAB_COLS_TOLOAD</span><span class="p">:</span>
                        <span class="n">col_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                        <span class="n">col_arr</span><span class="p">[</span><span class="n">fullsample_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psr_tab</span><span class="p">[</span><span class="n">col</span><span class="p">])[</span><span class="n">sort_psr_tab</span><span class="p">]</span>
                        <span class="n">psr_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_arr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSRTAB_COLS_TOLOAD</span><span class="p">:</span>
                        <span class="n">psr_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="n">table</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Fixing seeds...&#39;</span><span class="p">)</span>
            <span class="n">new_seed_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">samplesize</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_seed_arr</span><span class="p">):</span>
                <span class="n">new_seed_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s1">_1e6Z_</span><span class="si">{</span><span class="mf">1e6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sample_metallicity</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">_1e3M1_</span><span class="si">{</span><span class="mf">1e3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sample_m1</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_seed_arr</span>

            <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done loading table </span><span class="si">{</span><span class="n">hdf_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">. Elapsed time: </span><span class="si">{</span><span class="n">total_time</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> s.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">psr_df</span>

    <span class="k">def</span> <span class="nf">_process_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">psr_df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Processing table...&#39;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Fixing final masses...&#39;</span><span class="p">)</span>
        <span class="c1"># df.parallel_apply(symmetrize_masses, axis=1)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pull_snmass1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pull_snmass2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Mass(SN)&#39;</span><span class="p">,</span> <span class="s1">&#39;Mass(CP)&#39;</span><span class="p">,</span> <span class="s1">&#39;Mass(1)&#39;</span><span class="p">,</span> <span class="s1">&#39;Mass(2)&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Computing new mass columns...&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Chirp_Mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">chirp_mass</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Total_Mass_PostSN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Initial_Mass(2)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Initial_Mass(1)&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mass_Ratio&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Total_Mass_ZAMS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Initial_Mass(1)&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Initial_Mass(2)&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mass_Ratio_PostSN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mass_ratio</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># df[&#39;Mass_Ratio_ZAMS&#39;] = df.apply(lambda x: mass_ratio(x[&#39;Initial_Mass(1)&#39;], x[&#39;Initial_Mass(2)&#39;]), axis=1)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">]</span>  <span class="c1"># time in years</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Computing ZAMS orbital period...&#39;</span><span class="p">)</span>
        <span class="c1"># df[&#39;LogP_ZAMS&#39;] = df.parallel_apply(lambda x: np.float32(a_to_logp_table(x[&#39;SemiMajorAxis@ZAMS&#39;],</span>
        <span class="c1">#                                                                         x[&#39;Total_Mass_ZAMS&#39;])), axis=1)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;LogP_ZAMS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="n">logp_finder</span> <span class="o">=</span> <span class="n">LogPFinder</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">m1</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Initial_Mass(1)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">logp_finder</span><span class="o">.</span><span class="n">set_m1</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>
            <span class="n">subdf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Initial_Mass(1)&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m1</span><span class="p">]</span>
            <span class="n">subdf</span><span class="p">[</span><span class="s1">&#39;LogP_ZAMS&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">subdf</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">logp_finder</span><span class="o">.</span><span class="n">a_to_logp_table</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;SemiMajorAxis@ZAMS&#39;</span><span class="p">],</span>
                                                                             <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Total_Mass_ZAMS&#39;</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#print(subdf[&#39;LogP_ZAMS&#39;])</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;LogP_ZAMS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">]</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s1">&#39;LogP_ZAMS&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Fixing categorical columns and column names...&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type(1)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type(1)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type(2)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type(2)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Binary_Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type(1)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type(2)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">bintype</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type(1)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type(1)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type(2)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type(2)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Binary_Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Binary_Type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Initial_Mass(1)&#39;</span><span class="p">:</span> <span class="s1">&#39;Mass_ZAMS1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Initial_Mass(2)&#39;</span><span class="p">:</span> <span class="s1">&#39;Mass_ZAMS2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Mass_Ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Stellar_Type(1)&#39;</span><span class="p">:</span> <span class="s1">&#39;Stellar_Type1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Stellar_Type(2)&#39;</span><span class="p">:</span> <span class="s1">&#39;Stellar_Type2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Metallicity@ZAMS(1)&#39;</span><span class="p">:</span> <span class="s1">&#39;Metallicity_ZAMS&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SemiMajorAxis@ZAMS&#39;</span><span class="p">:</span> <span class="s1">&#39;SemiMajorAxis_ZAMS&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Eccentricity@ZAMS&#39;</span><span class="p">:</span> <span class="s1">&#39;Eccentricity_ZAMS&#39;</span><span class="p">,</span>
        <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span> <span class="ow">and</span> <span class="n">psr_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psr_col_rename_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;MT_History&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_MT_History&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Mass(1)&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_Mass1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Mass(2)&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_Mass2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Pulsar_Mag_Field(1)&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_B1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Pulsar_Mag_Field(2)&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_B2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Pulsar_Spin_Down(1)&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_Pdot1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Pulsar_Spin_Down(2)&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_Pdot2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Pulsar_Spin_Freq(1)&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_Omega1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Pulsar_Spin_Freq(2)&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_Omega2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;SemiMajorAxis&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SemiMajorAxis&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Stellar_Type(1)&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_Type1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Stellar_Type(2)&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_Type2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Time&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_Time&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dT&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_dT&#39;</span>
            <span class="p">}</span>
            <span class="n">psr_sn_col_rename_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;Mass_Core@CO(SN)1&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Mass_Core1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Mass_Core@CO(SN)2&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Mass_Core2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Mass_He_Core@CO(SN)1&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Mass_He_Core1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Mass_He_Core@CO(SN)2&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Mass_He_Core2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Mass_CO_Core@CO(SN)1&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Mass_CO_Core1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Mass_CO_Core@CO(SN)2&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Mass_CO_Core2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Fallback_Fraction(SN)1&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Fallback_Fraction1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Fallback_Fraction(SN)2&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Fallback_Fraction2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Kick_Magnitude(uK)1&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Kick_Magnitude1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Kick_Magnitude(uK)2&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Kick_Magnitude2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;SystemicSpeed1&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_SystemicSpeed1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;SystemicSpeed2&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_SystemicSpeed2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Time1&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Time1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Time2&#39;</span><span class="p">:</span> <span class="s1">&#39;PSR_SN_Time2&#39;</span>
            <span class="p">}</span>
            <span class="n">psr_new_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">psr_col_rename_dict</span><span class="p">[</span><span class="n">old_col</span><span class="p">]</span> <span class="k">for</span> <span class="n">old_col</span> <span class="ow">in</span> <span class="n">psr_col_rename_dict</span><span class="p">]</span>
            <span class="n">psr_new_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="n">psr_sn_col_rename_dict</span><span class="p">[</span><span class="n">old_col</span><span class="p">]</span> <span class="k">for</span> <span class="n">old_col</span> <span class="ow">in</span> <span class="n">psr_sn_col_rename_dict</span><span class="p">]</span>
            <span class="n">psr_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">psr_col_rename_dict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">psr_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">psr_sn_col_rename_dict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">psr_col_rename_dict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">psr_sn_col_rename_dict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">psr_new_cols</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">psr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">psr_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">psr_df</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_pulsar_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;_save_pulsars_columns is True, but psr_df is None.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SNTAB_PSR_COLS_TOLOAD</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># pandarallel turns all float32 cols to float64, so we have to convert them back to float32</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">float32_cols</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">downcast</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done. Table processed in </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">}</span><span class="s1"> s.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="COMPASOutputTrimmer.gen_subdfs">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.COMPASOutputTrimmer.gen_subdfs">[docs]</a>
    <span class="k">def</span> <span class="nf">gen_subdfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">all_soft_cos_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">CO_CODES</span><span class="p">)</span> <span class="o">|</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">CO_CODES</span><span class="p">)]</span>
        <span class="n">bound_soft_cos_df</span> <span class="o">=</span> <span class="n">all_soft_cos_df</span><span class="p">[</span><span class="n">all_soft_cos_df</span><span class="p">[</span><span class="s1">&#39;Unbound&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">bound_hard_cos_df</span> <span class="o">=</span> <span class="n">bound_soft_cos_df</span><span class="p">[</span><span class="n">bound_soft_cos_df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span> <span class="o">&amp;</span> \
                                              <span class="n">bound_soft_cos_df</span><span class="p">[</span><span class="s1">&#39;Stellar_Type2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">all_soft_cos_df</span><span class="p">,</span> <span class="n">bound_soft_cos_df</span><span class="p">,</span> <span class="n">bound_hard_cos_df</span></div>


<div class="viewcode-block" id="COMPASOutputTrimmer.trim">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.COMPASOutputTrimmer.trim">[docs]</a>
    <span class="k">def</span> <span class="nf">trim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing trimmer...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_paths</span><span class="p">()</span>
        <span class="c1">#pandarallel.initialize()</span>
        <span class="n">total_time0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_paths</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">psr_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_df_from_hdf</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No data loaded from HDF file, stopping trimmer.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">psr_df</span><span class="p">)</span>
                <span class="c1"># allsoft_df, boundsoft_df, boundhard_df = self.gen_subdfs(df)</span>
                <span class="n">write_time0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trimmed_output_path</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trimmed_output_path</span><span class="p">,</span> <span class="o">**</span><span class="n">PARQUET_SETTINGS</span><span class="p">)</span>
                <span class="c1"># allsoft_df.to_parquet(path=Path(self.trimmed_output_path.parent, &#39;allsoft&#39;+self.trimmed_output_path.name), **PARQUET_SETTINGS)</span>
                <span class="c1"># boundsoft_df.to_parquet(path=Path(self.trimmed_output_path.parent, &#39;boundsoft&#39;+self.trimmed_output_path.name), **PARQUET_SETTINGS)</span>
                <span class="c1"># boundhard_df.to_parquet(path=Path(self.trimmed_output_path.parent, &#39;boundhard&#39;+self.trimmed_output_path.name), **PARQUET_SETTINGS)</span>
                <span class="n">write_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">write_time0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done. Table written in </span><span class="si">{</span><span class="n">write_time</span><span class="si">}</span><span class="s1"> s.&#39;</span><span class="p">)</span>
                <span class="n">table_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total table processing time: </span><span class="si">{</span><span class="n">table_time</span><span class="si">}</span><span class="s1"> s.&#39;</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">total_time0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done trimming </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compas_output_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1">. Total elapsed time: </span><span class="si">{</span><span class="n">total_time</span><span class="si">}</span><span class="s1"> s.&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LogPFinder">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.LogPFinder">[docs]</a>
<span class="k">class</span> <span class="nc">LogPFinder</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zams</span> <span class="o">=</span> <span class="n">ZAMSSystemGenerator</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">BINARIES_CORRELATED_TABLE_PATH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zams</span><span class="o">.</span><span class="n">setup_sampler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m1group</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logp_options</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logp_categories</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="LogPFinder.set_m1">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.LogPFinder.set_m1">[docs]</a>
    <span class="k">def</span> <span class="nf">set_m1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zams</span><span class="o">.</span><span class="n">m1_array</span> <span class="o">=</span> <span class="n">m1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m1group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zams</span><span class="o">.</span><span class="n">_get_m1</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logp_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logp_categories</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">m1group</span><span class="o">.</span><span class="n">_v_children</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logp_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m1group</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logp_categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m1group</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logp_options</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logp_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logp_categories</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logp_categories</span><span class="p">)</span>
        <span class="n">sorting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logp_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logp_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logp_options</span><span class="p">[</span><span class="n">sorting</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logp_categories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logp_categories</span><span class="p">[</span><span class="n">sorting</span><span class="p">]</span></div>


<div class="viewcode-block" id="LogPFinder.get_closest_logp">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.LogPFinder.get_closest_logp">[docs]</a>
    <span class="k">def</span> <span class="nf">get_closest_logp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logp</span><span class="p">):</span>
        <span class="n">closest_logp_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logp_options</span> <span class="o">-</span> <span class="n">logp</span><span class="p">))</span>
        <span class="n">closest_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logp_categories</span><span class="p">[</span><span class="n">closest_logp_i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">closest_logp</span></div>


<div class="viewcode-block" id="LogPFinder.a_to_logp_table">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.LogPFinder.a_to_logp_table">[docs]</a>
    <span class="k">def</span> <span class="nf">a_to_logp_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">m_tot</span><span class="p">):</span>
        <span class="n">cgs_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">au</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">cgs</span> <span class="o">*</span> <span class="n">m_tot</span> <span class="o">*</span> <span class="n">ct</span><span class="o">.</span><span class="n">M_sun</span><span class="p">))</span>
        <span class="n">cgs_p</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="n">cgs_a</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">logp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cgs_p</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">logp_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_closest_logp</span><span class="p">(</span><span class="n">logp</span><span class="p">)</span>
        <span class="c1"># logp_table = np.around(logp, 4)</span>
        <span class="k">return</span> <span class="n">logp_table</span></div>
</div>



<div class="viewcode-block" id="CompactBinaryPopulation">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.CompactBinaryPopulation">[docs]</a>
<span class="k">class</span> <span class="nc">CompactBinaryPopulation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cross-match generated ZAMS populations and COMPAS output to produce a binary compact object population.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parent_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">canonical_distributions</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zams_population_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compas_feh_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compas_feh_options</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zams_redshift_feh_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_processes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossmatch_tol</span> <span class="o">=</span> <span class="mf">1e-5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_progress</span> <span class="o">=</span> <span class="n">print_progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canonical_initial_distributions</span> <span class="o">=</span> <span class="n">canonical_distributions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compas_proc_output_dir_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compas_grids_folder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logger</span><span class="p">(</span><span class="n">parent_logger</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compas_proc_output_dir_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compas_proc_output_dir_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonical_initial_distributions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compas_proc_output_dir_path</span> <span class="o">=</span> <span class="n">COMPAS_21XX_PROC_OUTPUT_DIR_PATH</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compas_proc_output_dir_path</span> <span class="o">=</span> <span class="n">COMPAS_12XX_PROC_OUTPUT_DIR_PATH</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compas_proc_output_dir_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compas_grids_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compas_grids_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonical_initial_distributions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compas_grids_folder</span> <span class="o">=</span> <span class="n">COMPAS_21XX_GRIDS_PATH</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compas_grids_folder</span> <span class="o">=</span> <span class="n">COMPAS_12XX_GRIDS_PATH</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compas_grids_folder</span>

    <span class="k">def</span> <span class="nf">_get_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_logger</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parent_logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loggername</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">loggername</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y_%H:%M:%S.log&#39;</span><span class="p">))</span>
            <span class="n">log_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">loggername</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loggername</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">loggername</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logger</span>

    <span class="k">def</span> <span class="nf">_get_compas_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load COMPAS output paths and corresponding metallicities.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sample_folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compas_proc_output_dir_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.parquet&#39;</span><span class="p">):</span>
            <span class="n">feh</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sample_folder</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">1e2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compas_feh_dict</span><span class="p">[</span><span class="n">feh</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compas_feh_options</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compas_feh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">_get_zams_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load ZAMS sample paths and corresponding redshift, metallicity and other parameters.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sample_file</span> <span class="ow">in</span> <span class="n">IGIMF_ZAMS_DIR_PATH</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;z=*_feh=*_logsfr=*_1e4ZOH=*_1e2Mgal=*_1e2logn=*_logpool=*_&#39;</span> \
                                                    <span class="s1">&#39;igimf_zams_sample.parquet&#39;</span><span class="p">):</span>
            <span class="n">z</span><span class="p">,</span> <span class="n">feh</span><span class="p">,</span> <span class="n">logsfr</span><span class="p">,</span> <span class="n">zoh</span><span class="p">,</span> <span class="n">mgal</span><span class="p">,</span> <span class="n">logn</span><span class="p">,</span> <span class="n">logpool</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">sample_file</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># sample redshift</span>
            <span class="n">feh</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">feh</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># sample [Fe/H]</span>
            <span class="n">logsfr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">logsfr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># sample log10(SFR)</span>
            <span class="n">zoh</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">zoh</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">1e4</span><span class="p">)</span>  <span class="c1"># sample Z_O/H</span>
            <span class="n">mgal</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">mgal</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">1e2</span><span class="p">)</span>  <span class="c1"># sample galaxy stellar mass</span>
            <span class="n">logn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">logn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">1e2</span><span class="p">)</span>  <span class="c1"># sample log10(galaxy number density)</span>
            <span class="n">logpool</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">logpool</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># sample log10(mass pool size)</span>
            <span class="k">if</span> <span class="n">z</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zams_redshift_feh_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zams_redshift_feh_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">sample_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;redshift&#39;</span> <span class="p">:</span> <span class="n">z</span><span class="p">,</span>
                             <span class="s1">&#39;feh&#39;</span> <span class="p">:</span> <span class="n">feh</span><span class="p">,</span>
                             <span class="s1">&#39;logsfr&#39;</span> <span class="p">:</span> <span class="n">logsfr</span><span class="p">,</span>
                             <span class="s1">&#39;zoh&#39;</span> <span class="p">:</span> <span class="n">zoh</span><span class="p">,</span>
                             <span class="s1">&#39;mgal&#39;</span> <span class="p">:</span> <span class="n">mgal</span><span class="p">,</span>
                             <span class="s1">&#39;logn&#39;</span> <span class="p">:</span> <span class="n">logn</span><span class="p">,</span>
                             <span class="s1">&#39;logpoolsize&#39;</span> <span class="p">:</span> <span class="n">logpool</span><span class="p">,</span>
                             <span class="s1">&#39;path&#39;</span> <span class="p">:</span> <span class="n">sample_file</span>
                             <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zams_redshift_feh_dict</span><span class="p">[</span><span class="n">z</span><span class="p">][</span><span class="n">feh</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_params</span>

    <span class="k">def</span> <span class="nf">_crossmatch_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zams_df</span><span class="p">,</span> <span class="n">compas_sample_path</span><span class="p">,</span> <span class="n">feh</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cross-match a dataframe holding the ZAMS population with the nearest metallicity COMPAS output.&quot;&quot;&quot;</span>
        <span class="c1"># First, set up arrays to hold columns of the final cross-matched dataframe.</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zams_df</span><span class="p">)</span>
        <span class="n">m1_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">m2_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">coalescence_t_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">unbound_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># whether the binary became unbound following a supernova (bool)</span>
        <span class="n">seed_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>  <span class="c1"># unique identifier from binary parameters</span>
        <span class="n">binary_type_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>  <span class="c1"># BHBH, BHNS, NSBH, NSNS or isolated (for mass accounting)</span>

        <span class="n">prev_progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hit_count</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># successful matches counter</span>
        <span class="n">iteration_times</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># for progress updates to stdout</span>
        <span class="n">matched_df_i</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># index</span>
        <span class="k">for</span> <span class="n">zams_i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">zams_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="c1"># In the ZAMS sample, the &#39;Found&#39; m1, as well as LogP, &#39;Found&#39; q and e, are values taken directly from the</span>
            <span class="c1"># same sampling table from which the initial binary grid for COMPAS is built, allowing for an exact match</span>
            <span class="c1"># within the table&#39;s original float32 precision.</span>
            <span class="n">zams_m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Mass_ZAMS1_Found&#39;</span><span class="p">])</span>
            <span class="n">zams_logp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;LogOrbitalPeriod_ZAMS&#39;</span><span class="p">])</span>
            <span class="n">zams_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;MassRatioFound_ZAMS&#39;</span><span class="p">])</span>
            <span class="n">zams_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Eccentricity_ZAMS&#39;</span><span class="p">])</span>

            <span class="n">isolated_star</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">unevolved_binary</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">zams_logp</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">isolated_star</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">zams_m1</span><span class="o">*</span><span class="n">zams_q</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">unevolved_binary</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">isolated_star</span><span class="p">:</span>
                <span class="c1">#print(&#39;ISOLATED&#39;)</span>
                <span class="n">match_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s1">&#39;Unbound&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="s1">&#39;Coalescence_Time&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s1">&#39;SEED&#39;</span> <span class="p">:</span> <span class="s1">&#39;isolated&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Binary_Type&#39;</span> <span class="p">:</span> <span class="s1">&#39;isolated&#39;</span><span class="p">}</span>
                <span class="n">match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">match_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">unevolved_binary</span><span class="p">:</span>
                <span class="n">match_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s1">&#39;Unbound&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s1">&#39;SEED&#39;</span><span class="p">:</span> <span class="s1">&#39;unevolved&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Binary_Type&#39;</span><span class="p">:</span> <span class="s1">&#39;unevolved&#39;</span><span class="p">}</span>
                <span class="n">match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">match_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The COMPAS sample files are structured hierarchically: first-level folders correspond each to a m1, second</span>
                <span class="c1"># -level to a m1,logP pair, and third-level files each to a m1,logP,q,e set. The corresponding m1 and logP</span>
                <span class="c1"># are stored in the folder title to which the ZAMS binaries are matched.</span>
                <span class="n">compas_path_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compas_sample_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
                <span class="n">m1_options</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">compas_path_options</span><span class="p">])</span>
                <span class="c1"># Finding the closet parameters instead of an exact match helps avoid eventual floating-point errors.</span>
                <span class="n">m1path_closest_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m1_options</span> <span class="o">-</span> <span class="n">zams_m1</span><span class="p">))</span>
                <span class="n">compas_m1_path</span> <span class="o">=</span> <span class="n">compas_path_options</span><span class="p">[</span><span class="n">m1path_closest_i</span><span class="p">]</span>

                <span class="n">logp_path_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compas_m1_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
                <span class="n">logp_options</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">logp_path_options</span><span class="p">])</span>
                <span class="n">logp_path_closest_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">logp_options</span> <span class="o">-</span> <span class="n">zams_logp</span><span class="p">))</span>
                <span class="n">compas_logp_path</span> <span class="o">=</span> <span class="n">logp_path_options</span><span class="p">[</span><span class="n">logp_path_closest_i</span><span class="p">]</span>

                <span class="n">tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossmatch_tol</span>
                <span class="n">match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
                    <span class="n">path</span><span class="o">=</span><span class="n">compas_logp_path</span><span class="p">,</span>
                    <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span>
                    <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="s1">&#39;Eccentricity_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">zams_e</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tol</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;Eccentricity_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">zams_e</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tol</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">zams_q</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tol</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">zams_q</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tol</span><span class="p">))</span>
                    <span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                        <span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Unbound&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;SEED&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Binary_Type&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Eccentricity_ZAMS&#39;</span>
                    <span class="p">],</span>
                    <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time0</span>
            <span class="n">iteration_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time1</span><span class="p">)</span>

            <span class="n">tolerance_warning</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="n">match_df</span><span class="o">.</span><span class="n">SEED</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonical_initial_distributions</span><span class="p">:</span>
                    <span class="c1"># Because in this case e=0 always, for a given (m1,logp,q) there will be 10 repeated (q,e=0) lines</span>
                    <span class="c1"># in the table, which get passed to COMPAS.</span>
                    <span class="n">match_qs</span> <span class="o">=</span> <span class="n">match_df</span><span class="o">.</span><span class="n">Mass_Ratio_ZAMS</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="n">match_es</span> <span class="o">=</span> <span class="n">match_df</span><span class="o">.</span><span class="n">Eccentricity_ZAMS</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_qs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_es</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">match_df</span> <span class="o">=</span> <span class="n">match_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="n">tolerance_warning</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Lowering tolerance for </span><span class="si">{</span><span class="n">zams_m1</span><span class="p">,</span><span class="w"> </span><span class="n">zams_logp</span><span class="p">,</span><span class="w"> </span><span class="n">zams_q</span><span class="p">,</span><span class="w"> </span><span class="n">zams_e</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">compas_logp_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">tolerance_warning</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">tol</span> <span class="o">*=</span> <span class="mf">0.9</span>
                <span class="n">match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
                    <span class="n">path</span><span class="o">=</span><span class="n">compas_logp_path</span><span class="p">,</span>
                    <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span>
                    <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="s1">&#39;Eccentricity_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">zams_e</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tol</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;Eccentricity_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">zams_e</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tol</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">zams_q</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tol</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">zams_q</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tol</span><span class="p">))</span>
                    <span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                        <span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Unbound&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;SEED&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Binary_Type&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Eccentricity_ZAMS&#39;</span>
                    <span class="p">],</span>
                    <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">tol</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tolerance too low, checking gridfiles...&#39;</span><span class="p">)</span>
                    <span class="n">gridfile_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compas_grids_folder</span><span class="p">,</span> <span class="n">compas_sample_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="s1">&#39;run_gridfiles&#39;</span><span class="p">)</span>
                    <span class="n">m1_gridfile_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gridfile_folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*_grid.txt&#39;</span><span class="p">))</span>
                    <span class="n">m1_grid_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">m1_gridfile_options</span><span class="p">)</span>
                    <span class="n">m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">compas_m1_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="n">closest_m1_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">m1_grid_options</span><span class="p">)</span> <span class="o">-</span> <span class="n">m1</span><span class="p">))</span>
                    <span class="n">m1_grid</span> <span class="o">=</span> <span class="n">m1_gridfile_options</span><span class="p">[</span><span class="n">closest_m1_i</span><span class="p">]</span>
                    <span class="n">match_seeds</span> <span class="o">=</span> <span class="n">match_df</span><span class="o">.</span><span class="n">SEED</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">seed_suffix</span> <span class="o">=</span> <span class="n">match_seeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">match_seeds</span> <span class="o">=</span> <span class="p">[</span><span class="n">seed</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">match_seeds</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Looking for </span><span class="si">{</span><span class="n">match_seeds</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">m1_grid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">def</span> <span class="nf">look_for_seeds</span><span class="p">(</span><span class="n">match_seeds</span><span class="p">):</span>
                        <span class="n">match_lines</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">with</span> <span class="n">m1_grid</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                                <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">match_seeds</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                        <span class="n">match_lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seed</span><span class="p">,</span> <span class="n">line</span><span class="p">])</span>
                                        <span class="n">match_seeds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_seeds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="k">return</span> <span class="n">match_lines</span>

                    <span class="n">match_lines</span> <span class="o">=</span> <span class="n">look_for_seeds</span><span class="p">(</span><span class="n">match_seeds</span><span class="p">)</span>
                    <span class="n">matched_seed</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">prev_d_logp</span> <span class="o">=</span> <span class="mi">10</span>
                    <span class="k">for</span> <span class="n">seed_line</span> <span class="ow">in</span> <span class="n">match_lines</span><span class="p">:</span>
                        <span class="n">seed</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">seed_line</span>
                        <span class="n">settings</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                        <span class="n">logp_i</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;--orbital-period&#39;</span><span class="p">)</span>
                        <span class="n">logp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="n">logp_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">d_logp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">logp</span> <span class="o">-</span> <span class="n">zams_logp</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">d_logp</span> <span class="o">&lt;</span> <span class="n">prev_d_logp</span><span class="p">:</span>
                            <span class="n">prev_d_logp</span> <span class="o">=</span> <span class="n">d_logp</span>
                            <span class="n">matched_seed</span> <span class="o">=</span> <span class="n">seed</span>

                        <span class="n">match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
                            <span class="n">path</span><span class="o">=</span><span class="n">compas_logp_path</span><span class="p">,</span>
                            <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span>
                            <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
                                <span class="p">(</span><span class="s1">&#39;SEED&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">matched_seed</span><span class="p">,</span> <span class="o">*</span><span class="n">seed_suffix</span><span class="p">]))</span>
                            <span class="p">],</span>
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                                <span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Unbound&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;SEED&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Binary_Type&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Eccentricity_ZAMS&#39;</span>
                            <span class="p">],</span>
                            <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>

            <span class="k">if</span> <span class="n">match_df</span><span class="o">.</span><span class="n">SEED</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#print(zams_m1, zams_logp, zams_q, np.float32(row[&#39;MassRatioChoice_ZAMS&#39;]), zams_e)</span>
                <span class="c1">#print(compas_logp_path)</span>
                <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
                    <span class="n">path</span><span class="o">=</span><span class="n">compas_logp_path</span><span class="p">,</span>
                    <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                        <span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Eccentricity_ZAMS&#39;</span>
                    <span class="p">],</span>
                    <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="c1">#print(match_df)</span>
                <span class="c1">#print(len(match_df), &#39;LEN&#39;)</span>
                <span class="c1">#print(&#39;q,e pairs&#39;, np.array([match_df.Mass_Ratio_ZAMS.to_numpy(),</span>
                <span class="c1">#                             match_df.Eccentricity_ZAMS.to_numpy()]).T)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_df</span><span class="o">.</span><span class="n">Eccentricity_ZAMS</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">full_df</span><span class="o">.</span><span class="n">Eccentricity_ZAMS</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">max_q</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">full_df</span><span class="o">.</span><span class="n">Mass_Ratio_ZAMS</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">zams_q</span> <span class="o">&gt;</span> <span class="n">max_q</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Close massive binary&#39;</span><span class="p">)</span>
                        <span class="n">match_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;Unbound&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;SEED&#39;</span><span class="p">:</span> <span class="s1">&#39;merged_at_birth&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;Binary_Type&#39;</span><span class="p">:</span> <span class="s1">&#39;merged_at_birth&#39;</span><span class="p">}</span>
                        <span class="n">match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">match_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">compas_logp_path</span><span class="p">,</span>
                        <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span>
                        <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
                            <span class="p">(</span><span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">zams_q</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tol</span><span class="p">)),</span>
                            <span class="p">(</span><span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">zams_q</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tol</span><span class="p">))</span>
                        <span class="p">],</span>
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                            <span class="s1">&#39;Eccentricity_ZAMS&#39;</span>
                        <span class="p">],</span>
                        <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">zams_e</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">full_df</span><span class="o">.</span><span class="n">Eccentricity_ZAMS</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Eccentric massive binary&#39;</span><span class="p">)</span>
                        <span class="n">match_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;Unbound&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                      <span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                      <span class="s1">&#39;SEED&#39;</span><span class="p">:</span> <span class="s1">&#39;merged_at_birth&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;Binary_Type&#39;</span><span class="p">:</span> <span class="s1">&#39;merged_at_birth&#39;</span><span class="p">}</span>
                        <span class="n">match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">match_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">match_df</span><span class="o">.</span><span class="n">SEED</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">hit_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">match_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">m1_col</span><span class="p">[</span><span class="n">matched_df_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">]</span>
                <span class="n">m2_col</span><span class="p">[</span><span class="n">matched_df_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">]</span>
                <span class="n">coalescence_t_col</span><span class="p">[</span><span class="n">matched_df_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">]</span>
                <span class="n">unbound_col</span><span class="p">[</span><span class="n">matched_df_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="s1">&#39;Unbound&#39;</span><span class="p">]</span>
                <span class="n">seed_col</span><span class="p">[</span><span class="n">matched_df_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="s1">&#39;SEED&#39;</span><span class="p">]</span>
                <span class="n">binary_type_col</span><span class="p">[</span><span class="n">matched_df_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="s1">&#39;Binary_Type&#39;</span><span class="p">]</span>
                <span class="n">matched_df_i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">matched_df_i</span><span class="o">/</span><span class="n">sample_size</span>
            <span class="k">elif</span> <span class="n">match_df</span><span class="o">.</span><span class="n">SEED</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">zams_m1</span><span class="p">,</span> <span class="n">zams_logp</span><span class="p">,</span> <span class="n">zams_q</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;MassRatioChoice_ZAMS&#39;</span><span class="p">]),</span> <span class="n">zams_e</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">compas_logp_path</span><span class="p">)</span>
                <span class="n">match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
                    <span class="n">path</span><span class="o">=</span><span class="n">compas_logp_path</span><span class="p">,</span>
                    <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span>
                    <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="s1">&#39;Eccentricity_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">zams_e</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">5e-1</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;Eccentricity_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">zams_e</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">5e-1</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">zams_q</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">5e-1</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">zams_q</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">5e-1</span><span class="p">))</span>
                    <span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                        <span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Unbound&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;SEED&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Binary_Type&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Mass_Ratio_ZAMS&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Eccentricity_ZAMS&#39;</span>
                    <span class="p">],</span>
                    <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">match_df</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match_df</span><span class="p">),</span> <span class="s1">&#39;LEN&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;q,e pairs&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">match_df</span><span class="o">.</span><span class="n">Mass_Ratio_ZAMS</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                             <span class="n">match_df</span><span class="o">.</span><span class="n">Eccentricity_ZAMS</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Could not match system. Consider raising parameter match tolerances.&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">zams_m1</span><span class="p">,</span> <span class="n">zams_logp</span><span class="p">,</span> <span class="n">zams_q</span><span class="p">,</span> <span class="n">zams_e</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">match_df</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Multiple matches found in COMPAS sample. Consider lowering parameter match tolerances.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_progress</span> <span class="ow">and</span> <span class="n">progress</span> <span class="o">&gt;</span> <span class="n">prev_progress</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">iteration_times</span><span class="p">)</span>
                <span class="n">avg_match_rate</span> <span class="o">=</span> <span class="n">matched_df_i</span><span class="o">/</span><span class="n">elapsed_time</span>
                <span class="n">expected_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_size</span><span class="o">-</span><span class="n">matched_df_i</span><span class="p">)</span> <span class="o">/</span> <span class="n">avg_match_rate</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Progress: </span><span class="si">{</span><span class="n">progress</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> %    </span><span class="si">{</span><span class="n">format_time</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">format_time</span><span class="p">(</span><span class="n">expected_time</span><span class="p">)</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">avg_match_rate</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> match / s&#39;</span><span class="p">)</span>
                <span class="n">prev_progress</span> <span class="o">=</span> <span class="n">progress</span>

        <span class="c1"># As zams_df already holds the initial parameter columns, simply add the final parameter columns to it.</span>
        <span class="n">zams_df</span><span class="p">[</span><span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m1_col</span>
        <span class="n">zams_df</span><span class="p">[</span><span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m2_col</span>
        <span class="n">zams_df</span><span class="p">[</span><span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coalescence_t_col</span>
        <span class="n">zams_df</span><span class="p">[</span><span class="s1">&#39;Unbound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unbound_col</span>
        <span class="n">zams_df</span><span class="p">[</span><span class="s1">&#39;SEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed_col</span>
        <span class="n">zams_df</span><span class="p">[</span><span class="s1">&#39;Binary_Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_type_col</span>
        <span class="k">return</span> <span class="n">zams_df</span>

    <span class="k">def</span> <span class="nf">_pick_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sample_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zams_redshift_feh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">zams_feh_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zams_redshift_feh_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">feh</span> <span class="ow">in</span> <span class="n">zams_feh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">zams_dict</span> <span class="o">=</span> <span class="n">zams_feh_dict</span><span class="p">[</span><span class="n">feh</span><span class="p">]</span>
                <span class="n">zams_z</span> <span class="o">=</span> <span class="n">zams_dict</span><span class="p">[</span><span class="s1">&#39;redshift&#39;</span><span class="p">]</span>
                <span class="n">zams_feh</span> <span class="o">=</span> <span class="n">zams_dict</span><span class="p">[</span><span class="s1">&#39;feh&#39;</span><span class="p">]</span>
                <span class="n">sample_option</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;z=</span><span class="si">{</span><span class="n">zams_z</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, [Fe/H]=</span><span class="si">{</span><span class="n">zams_feh</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">sample_options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample_option</span><span class="p">,</span>
                                       <span class="p">(</span><span class="n">zams_z</span><span class="p">,</span> <span class="n">zams_feh</span><span class="p">)))</span>

        <span class="n">question</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">inquirer</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="s1">&#39;choice&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Please pick a ZAMS sample to match to the COMPAS output&#39;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="n">sample_options</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="n">sample_choice</span> <span class="o">=</span> <span class="n">inquirer</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span><span class="n">question</span><span class="p">)[</span><span class="s1">&#39;choice&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sample_choice</span>

    <span class="k">def</span> <span class="nf">_crossmatch_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zams_sample_redshift</span><span class="p">,</span> <span class="n">zams_sample_feh</span><span class="p">):</span>
        <span class="n">zams_sample_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zams_redshift_feh_dict</span><span class="p">[</span><span class="n">zams_sample_redshift</span><span class="p">][</span><span class="n">zams_sample_feh</span><span class="p">]</span>
        <span class="n">zams_sample_path</span> <span class="o">=</span> <span class="n">zams_sample_dict</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now matching z=</span><span class="si">{</span><span class="n">zams_sample_redshift</span><span class="si">}</span><span class="s1">, [Fe/H]=</span><span class="si">{</span><span class="n">zams_sample_feh</span><span class="si">}</span><span class="s1"> ZAMS sample &#39;</span> \
                         <span class="sa">f</span><span class="s1">&#39;at </span><span class="si">{</span><span class="n">zams_sample_path</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="n">feh_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compas_feh_options</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compas_feh_options</span> <span class="o">-</span> <span class="n">zams_sample_feh</span><span class="p">))]</span>
        <span class="n">compas_sample_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compas_feh_dict</span><span class="p">[</span><span class="n">feh_match</span><span class="p">]</span>

        <span class="n">matched_sample_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">COMPACT_OBJ_DIR_PATH</span><span class="p">,</span>
                                   <span class="n">zams_sample_path</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_compasfeh=</span><span class="si">{</span><span class="n">zams_sample_feh</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.snappy.parquet&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Closest COMPAS sample: [Fe/H] = </span><span class="si">{</span><span class="n">zams_sample_feh</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">compas_sample_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">zams_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">zams_sample_path</span><span class="p">,</span>
                                  <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span>
                                  <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sub_zams_dfs_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">zams_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_processes</span><span class="p">)</span>
        <span class="n">compas_sample_path_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">compas_sample_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_processes</span><span class="p">)</span>
        <span class="n">feh_match_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">feh_match</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_processes</span><span class="p">)</span>

        <span class="n">matched_df_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="c1">#for df in executor.map(crossmatch, sub_zams_dfs_array):</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_crossmatch_df</span><span class="p">,</span> <span class="n">sub_zams_dfs_array</span><span class="p">,</span> <span class="n">compas_sample_path_array</span><span class="p">,</span> <span class="n">feh_match_array</span><span class="p">):</span>
                <span class="n">matched_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">matched_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">matched_df_list</span><span class="p">)</span>
        <span class="n">matched_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">matched_df_list</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="n">matched_m1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">matched_df</span><span class="p">[</span><span class="s1">&#39;Mass_ZAMS1_Found&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">m1</span> <span class="ow">in</span> <span class="n">matched_m1s</span><span class="p">:</span>
            <span class="n">temp_df</span> <span class="o">=</span> <span class="n">matched_df</span><span class="p">[</span><span class="n">matched_df</span><span class="p">[</span><span class="s1">&#39;Mass_ZAMS1_Found&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">m1</span><span class="p">]</span>
            <span class="n">temp_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">matched_sample_path</span><span class="p">,</span>
                               <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span>
                               <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;snappy&#39;</span><span class="p">,</span>
                               <span class="n">partition_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mass_ZAMS1_Found&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;LogOrbitalPeriod_ZAMS&#39;</span><span class="p">],</span>
                               <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">temp_df</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">matched_df</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_crossmatch_single_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sample_choice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pick_sample</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_crossmatch_sample</span><span class="p">(</span><span class="o">*</span><span class="n">sample_choice</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_crossmatch_full_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zams_redshift_feh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">zams_feh_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zams_redshift_feh_dict</span><span class="p">[</span><span class="n">z</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">feh</span> <span class="ow">in</span> <span class="n">zams_feh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_crossmatch_sample</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">feh</span><span class="p">)</span>

<div class="viewcode-block" id="CompactBinaryPopulation.crossmatch_sample">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.CompactBinaryPopulation.crossmatch_sample">[docs]</a>
    <span class="k">def</span> <span class="nf">crossmatch_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_zams_samples</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_compas_samples</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please enter the number of parallel processes to run:&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_processes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">())</span>

        <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="s1">&#39;Single&#39;</span><span class="p">]</span>
        <span class="n">question</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">inquirer</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="s1">&#39;choice&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Cross-match a single ZAMS sample or all ZAMS samples in </span><span class="si">{</span><span class="n">IGIMF_ZAMS_DIR_PATH</span><span class="si">}</span><span class="s1">?&#39;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="n">choices</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="n">inquirer</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span><span class="n">question</span><span class="p">)[</span><span class="s1">&#39;choice&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;All&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_crossmatch_full_sample</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_crossmatch_single_sample</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="MergerRates">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.MergerRates">[docs]</a>
<span class="k">class</span> <span class="nc">MergerRates</span><span class="p">:</span>
    <span class="n">COLS_TO_LOAD_ESSENTIAL</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Unbound&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Coalescence_Time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_ZAMS1_Found&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_PostSN1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mass_PostSN2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Binary_Type&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SystemMass&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CompanionNumber&#39;</span>
    <span class="p">]</span>
    <span class="n">COLS_TO_LOAD_EXTENDED</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="s1">&#39;Mass_ZAMS2_Found&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Mass_ZAMS3_Found&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Mass_ZAMS4_Found&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Mass_ZAMS5_Found&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;LogOrbitalPeriod_ZAMS&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Eccentricity_ZAMS&#39;</span>
                            <span class="p">]</span> <span class="o">+</span> <span class="n">COLS_TO_LOAD_ESSENTIAL</span>
    <span class="n">CATEGORY_COLS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Unbound&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Binary_Type&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CompanionNumber&#39;</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_dir_path</span><span class="p">,</span> <span class="n">zams_grid_path</span><span class="p">,</span> <span class="n">sfrd_model</span><span class="p">,</span> <span class="n">invariant_imf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">extended_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">load_bcos_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_redshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_redshift</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">min_feh</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span>
                 <span class="n">max_feh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">progenitor_m_min</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">progenitor_m_max</span><span class="o">=</span><span class="mf">150.0</span><span class="p">,</span> <span class="n">convert_time</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">new_method</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">parent_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_dir_path</span> <span class="o">=</span> <span class="n">sample_dir_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zams_grid_path</span> <span class="o">=</span> <span class="n">zams_grid_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merger_class</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfrd_model</span> <span class="o">=</span> <span class="n">sfrd_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invariant_imf</span> <span class="o">=</span> <span class="n">invariant_imf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canon_sfrd</span> <span class="o">=</span> <span class="n">invariant_imf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extended_load</span> <span class="o">=</span> <span class="n">extended_load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_bcos_only</span> <span class="o">=</span> <span class="n">load_bcos_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_redshift</span> <span class="o">=</span> <span class="n">min_redshift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_redshift</span> <span class="o">=</span> <span class="n">max_redshift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_feh</span> <span class="o">=</span> <span class="n">min_feh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_feh</span> <span class="o">=</span> <span class="n">max_feh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_min</span> <span class="o">=</span> <span class="n">progenitor_m_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_max</span> <span class="o">=</span> <span class="n">progenitor_m_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_star_m_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.08</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_min</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_star_m_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">150.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_max</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_time</span> <span class="o">=</span> <span class="n">convert_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_method</span> <span class="o">=</span> <span class="n">new_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sfrd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cols_to_load</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_paths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_mtot_per_ncomp_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_starforming_mass_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip_redshift_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_feh_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_feh_bins_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_edges</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_widths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_centers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_edges</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_widths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_centers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dfeh_mrates_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dfeh_dage_mrates_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_per_age_redshift_feh_fits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dage_mrates_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dpopage_mrates_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dpopage_interpolators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_dz_dpopage_mrates_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_dz_dage_mrates_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_per_age_redshift_fits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mrate_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logger</span><span class="p">(</span><span class="n">parent_logger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_logger</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parent_logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loggername</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">loggername</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y_%H:%M:%S.log&#39;</span><span class="p">))</span>
            <span class="n">log_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">create_logger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">loggername</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loggername</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">loggername</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logger</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_total_bco_mass</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the total binary compact object mass for a dataframe row.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">Mass_PostSN1</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">Mass_PostSN2</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_chirp_mass</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the chirp mass for a dataframe row.&quot;&quot;&quot;</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Mass_PostSN1</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Mass_PostSN2</span>
        <span class="k">if</span> <span class="n">m1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="n">m2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="n">m2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_merger_age</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate Universe age at merger for a dataframe row.&quot;&quot;&quot;</span>
        <span class="n">redshift_zams</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Redshift_ZAMS</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">age_zams</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">age</span><span class="p">(</span><span class="n">redshift_zams</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">t_col</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Coalescence_Time</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">age_merger</span> <span class="o">=</span> <span class="n">age_zams</span> <span class="o">+</span> <span class="n">t_col</span>
        <span class="k">return</span> <span class="n">age_merger</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_redshift_from_age</span><span class="p">(</span><span class="n">age_arr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate redshift from Universe age.&quot;&quot;&quot;</span>
        <span class="n">redshift_arr</span> <span class="o">=</span> <span class="n">newton</span><span class="p">(</span><span class="k">lambda</span> <span class="n">z_arr</span><span class="p">:</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">age</span><span class="p">(</span><span class="n">z_arr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">age_arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">age_arr</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">redshift_arr</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_bin_frequency_heights</span><span class="p">(</span><span class="n">x_arr</span><span class="p">,</span> <span class="n">x_bin_edges</span><span class="p">):</span>
        <span class="n">bin_frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_bin_edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">previous_x_arr_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">edge0</span><span class="p">,</span> <span class="n">edge1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
            <span class="n">x_arr</span> <span class="o">=</span> <span class="n">x_arr</span><span class="p">[</span><span class="n">x_arr</span> <span class="o">&gt;=</span> <span class="n">edge0</span><span class="p">]</span>
            <span class="n">x_arr_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_arr</span><span class="p">)</span>
            <span class="n">bin_count</span> <span class="o">=</span> <span class="n">previous_x_arr_len</span> <span class="o">-</span> <span class="n">x_arr_len</span>
            <span class="n">previous_x_arr_len</span> <span class="o">=</span> <span class="n">x_arr_len</span>
            <span class="n">bin_frequencies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_count</span> <span class="o">/</span> <span class="p">(</span><span class="n">edge1</span> <span class="o">-</span> <span class="n">edge0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bin_frequencies</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_linear_fit</span><span class="p">(</span><span class="n">xy0</span><span class="p">,</span> <span class="n">xy1</span><span class="p">):</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">xy0</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">xy1</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">intercept</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x0</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_linear_fit_area</span><span class="p">(</span><span class="n">linear_fit</span><span class="p">):</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">linear_fit</span>
        <span class="k">if</span> <span class="n">x0</span> <span class="o">==</span> <span class="n">x1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">intercept</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sfrd_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Which star formation rate density model from Chrulinska et al. (2020) to use.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sfrd_model</span>

    <span class="nd">@sfrd_model</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">sfrd_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lowmet&#39;</span><span class="p">,</span> <span class="s1">&#39;midmet&#39;</span><span class="p">,</span> <span class="s1">&#39;highmet&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sfrd_model must be one of </span><span class="si">{</span><span class="n">models</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sfrd_model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">canon_sfrd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the star formation rate grid to be loaded should assume a Canonical Kroupa IMF.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_canon_sfrd</span>

    <span class="nd">@canon_sfrd</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">canon_sfrd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invariant_imf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">invariant_imf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_canon_sfrd</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_canon_sfrd</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cols_to_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cols_to_load</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_load</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cols_to_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLS_TO_LOAD_EXTENDED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cols_to_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLS_TO_LOAD_ESSENTIAL</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cols_to_load</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sample_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sample_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_dir_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.parquet&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_paths</span>

    <span class="k">def</span> <span class="nf">_get_sfrd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sfrd</span> <span class="o">=</span> <span class="n">ChruslinskaSFRD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfrd_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">canon_sfrd</span><span class="p">,</span> <span class="n">per_redshift_met_bin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_method</span><span class="p">)</span>
        <span class="n">sfrd</span><span class="o">.</span><span class="n">set_grid</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sfrd</span>

    <span class="k">def</span> <span class="nf">_set_merger_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">):</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BHBH&#39;</span><span class="p">,</span> <span class="s1">&#39;BHNS&#39;</span><span class="p">,</span> <span class="s1">&#39;NSBH&#39;</span><span class="p">,</span> <span class="s1">&#39;NSNS&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">class_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;merger_class must be one of </span><span class="si">{</span><span class="n">classes</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">class_</span> <span class="o">==</span> <span class="s1">&#39;NSBH&#39;</span> <span class="ow">or</span> <span class="n">class_</span> <span class="o">==</span> <span class="s1">&#39;BHNS&#39;</span><span class="p">:</span>
            <span class="n">class_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BHNS&#39;</span><span class="p">,</span> <span class="s1">&#39;NSBH&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">class_</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merger_class</span> <span class="o">=</span> <span class="n">class_</span>

    <span class="k">def</span> <span class="nf">_set_sample_properties_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_paths</span><span class="p">:</span>
            <span class="n">redshift</span><span class="p">,</span> <span class="n">feh</span><span class="p">,</span> <span class="n">logsfr</span><span class="p">,</span> <span class="n">zoh1e4</span><span class="p">,</span> <span class="n">mgal1e2</span><span class="p">,</span> <span class="n">logn1e2</span><span class="p">,</span> <span class="n">logpool</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">compasfeh</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">redshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">redshift</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># z_{ZAMS}</span>
            <span class="n">feh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">feh</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># [Fe/H]</span>
            <span class="n">logsfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">logsfr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># log10(SFR)</span>
            <span class="n">zoh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">zoh1e4</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e4</span>  <span class="c1"># Z_{O/H}</span>
            <span class="n">mgal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">mgal1e2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e2</span>  <span class="c1"># stellar mass of the corresponding galaxy</span>
            <span class="n">logn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">logn1e2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e2</span>  <span class="c1"># log(number of stars in sample)</span>
            <span class="n">logpool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">logpool</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># log(length of the original mass sampling pool)</span>
            <span class="n">compas_feh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">compasfeh</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.snappy&#39;</span><span class="p">))</span>  <span class="c1"># closest [Fe/H] from the COMPAS samples</span>
            <span class="n">sample_properties</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;redshift&#39;</span><span class="p">:</span> <span class="n">redshift</span><span class="p">,</span>
                <span class="s1">&#39;feh&#39;</span><span class="p">:</span> <span class="n">feh</span><span class="p">,</span>
                <span class="s1">&#39;compas_feh&#39;</span><span class="p">:</span> <span class="n">compas_feh</span><span class="p">,</span>
                <span class="s1">&#39;zoh&#39;</span><span class="p">:</span> <span class="n">zoh</span><span class="p">,</span>
                <span class="s1">&#39;logsfr&#39;</span><span class="p">:</span> <span class="n">logsfr</span><span class="p">,</span>
                <span class="s1">&#39;mgal&#39;</span><span class="p">:</span> <span class="n">mgal</span><span class="p">,</span>
                <span class="s1">&#39;logn&#39;</span><span class="p">:</span> <span class="n">logn</span><span class="p">,</span>
                <span class="s1">&#39;logpool&#39;</span><span class="p">:</span> <span class="n">logpool</span><span class="p">,</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">redshift</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">][</span><span class="n">feh</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_properties</span>

    <span class="k">def</span> <span class="nf">_fix_df_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CATEGORY_COLS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s1">&#39;category&#39;</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols_to_load</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CATEGORY_COLS</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s1">&#39;float32&#39;</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_get_sample_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redshift_batch</span><span class="p">):</span>
        <span class="n">sample_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cols_to_load</span><span class="p">)</span>

        <span class="n">sample_n</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">redshift</span> <span class="ow">in</span> <span class="n">redshift_batch</span><span class="p">])</span>
        <span class="n">sample_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">redshift</span> <span class="ow">in</span> <span class="n">redshift_batch</span><span class="p">:</span>
            <span class="n">redshift_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">feh_</span> <span class="ow">in</span> <span class="n">redshift_dict</span><span class="p">:</span>
                <span class="n">sample_dict</span> <span class="o">=</span> <span class="n">redshift_dict</span><span class="p">[</span><span class="n">feh_</span><span class="p">]</span>
                <span class="n">z_zams</span> <span class="o">=</span> <span class="n">sample_dict</span><span class="p">[</span><span class="s1">&#39;redshift&#39;</span><span class="p">]</span>
                <span class="n">feh</span> <span class="o">=</span> <span class="n">sample_dict</span><span class="p">[</span><span class="s1">&#39;feh&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading z=</span><span class="si">{</span><span class="n">z_zams</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, [Fe/H]=</span><span class="si">{</span><span class="n">feh</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">sample_counter</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">sample_n</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_bcos_only</span><span class="p">:</span>
                    <span class="n">filters</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Binary_Type&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;BHBH&#39;</span><span class="p">,</span> <span class="s1">&#39;BHNS&#39;</span><span class="p">,</span> <span class="s1">&#39;NSBH&#39;</span><span class="p">,</span> <span class="s1">&#39;NSNS&#39;</span><span class="p">])]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filters</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
                    <span class="n">path</span><span class="o">=</span><span class="n">sample_dict</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cols_to_load</span><span class="p">,</span>
                    <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
                    <span class="c1"># Although loading only BCOs would be much faster and cheaper, we need to load all binary types at</span>
                    <span class="c1"># first in order to properly count the sample size when normalizing the imf for computing the</span>
                    <span class="c1"># star-forming mass. In the future this will be done, and the information stored, while generating</span>
                    <span class="c1"># the initial sample.</span>
                    <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;pyarrow&#39;</span><span class="p">,</span>
                    <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Redshift_ZAMS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">z_zams</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FeH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">feh</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_df_dtypes</span><span class="p">((</span><span class="n">df</span><span class="p">))</span>
                <span class="n">sample_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">df</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> rows to sub-sample dataframe.&#39;</span><span class="p">)</span>

                <span class="k">del</span> <span class="n">df</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="n">sample_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">sample_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sample_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_df_dtypes</span><span class="p">(</span><span class="n">sample_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample_df</span>

    <span class="k">def</span> <span class="nf">_set_sample_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches_n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">redshift_batches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()]),</span> <span class="n">batches_n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cols_to_load</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_df_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">redshift_batch</span> <span class="ow">in</span> <span class="n">redshift_batches</span><span class="p">:</span>
            <span class="n">sample_subdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_df</span><span class="p">(</span><span class="n">redshift_batch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">sample_subdf</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_subdf</span><span class="p">)</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> rows sub-sample dataframe to sample dataframe.&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">sample_subdf</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="n">sample_df_memory_usage_gb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done loading subsample to memory. Total memory usage from sample dataframe: &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sample_df_memory_usage_gb</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> GB&#39;</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#self.sample_df = self._fix_df_dtypes(self.sample_df)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done loading </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="p">)</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> rows to sample dataframe.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="MergerRates.load_sample_to_memory">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.MergerRates.load_sample_to_memory">[docs]</a>
    <span class="k">def</span> <span class="nf">load_sample_to_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches_n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Search sample folder for valid files...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_sample_properties_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> valid files, loading to sample dataframe...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_sample_df</span><span class="p">(</span><span class="n">batches_n</span><span class="p">)</span>
        <span class="n">sample_df_memory_usage_gb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">ncomp_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">CompanionNumber</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Multiplicity summary: </span><span class="se">\n</span><span class="si">{</span><span class="n">ncomp_summary</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;Please check this is the correct sample before proceeding.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MergerRates.get_mtot_per_ncomp">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.MergerRates.get_mtot_per_ncomp">[docs]</a>
    <span class="k">def</span> <span class="nf">get_mtot_per_ncomp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting raw sample star-forming masses...&#39;</span><span class="p">)</span>
        <span class="n">sample_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_paths</span><span class="p">)</span>
        <span class="n">sample_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">redshift</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">redshift</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_mtot_per_ncomp_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_mtot_per_ncomp_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">redshift_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_mtot_per_ncomp_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">feh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working for z=</span><span class="si">{</span><span class="n">redshift</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, [Fe/H]=</span><span class="si">{</span><span class="n">feh</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> sample (</span><span class="si">{</span><span class="n">sample_counter</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">sample_n</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">feh</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">redshift_dict</span><span class="p">:</span>
                    <span class="n">redshift_dict</span><span class="p">[</span><span class="n">feh</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">feh_dict</span> <span class="o">=</span> <span class="n">redshift_dict</span><span class="p">[</span><span class="n">feh</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ncp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">CompanionNumber</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                    <span class="n">ncp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">Redshift_ZAMS</span> <span class="o">==</span> <span class="n">redshift</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">FeH</span> <span class="o">==</span> <span class="n">feh</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">CompanionNumber</span> <span class="o">==</span> <span class="n">ncp</span><span class="p">)]</span>
                    <span class="n">sf_mass</span> <span class="o">=</span> <span class="n">ncp_df</span><span class="o">.</span><span class="n">SystemMass</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">feh_dict</span><span class="p">[</span><span class="n">ncp</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf_mass</span>
                    <span class="k">del</span> <span class="n">ncp_df</span>
                    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="n">sample_counter</span> <span class="o">+=</span> <span class="mi">1</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_kroupa_integral</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">):</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="mf">1.3</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="mf">2.3</span>
        <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span>
            <span class="n">a1</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">a2</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">m0</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m1</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="nb">int</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">m1</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a1</span><span class="p">)</span> <span class="o">-</span> <span class="n">m0</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">int</span> <span class="o">=</span> <span class="n">k1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a1</span><span class="p">)</span> <span class="o">-</span> <span class="n">m0</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a1</span><span class="p">))</span>
                <span class="nb">int</span> <span class="o">+=</span> <span class="n">k2</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">m1</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">int</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">m1</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a2</span><span class="p">)</span> <span class="o">-</span> <span class="n">m0</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a2</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">int</span>

<div class="viewcode-block" id="MergerRates.get_starforming_masses">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.MergerRates.get_starforming_masses">[docs]</a>
    <span class="k">def</span> <span class="nf">get_starforming_masses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_normalization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debugging</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting corresponding star-forming masses...&#39;</span><span class="p">)</span>
        <span class="n">sample_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_paths</span><span class="p">)</span>
        <span class="n">sample_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">redshift</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">redshift</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_starforming_mass_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_starforming_mass_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">redshift_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_starforming_mass_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">feh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Working for z=</span><span class="si">{</span><span class="n">redshift</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, [Fe/H]=</span><span class="si">{</span><span class="n">feh</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> sample (</span><span class="si">{</span><span class="n">sample_counter</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">sample_n</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">debugging</span><span class="p">:</span>
                    <span class="n">starforming_mass</span> <span class="o">=</span> <span class="mf">1e7</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invariant_imf</span><span class="p">:</span>
                        <span class="n">imf</span> <span class="o">=</span> <span class="n">Star</span><span class="p">(</span><span class="n">invariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">imf</span><span class="o">.</span><span class="n">get_mmax_k</span><span class="p">()</span>

                        <span class="c1">#imf_norm = self._kroupa_integral(imf.k1, imf.k2, self._star_m_min, self._star_m_max, &#39;number&#39;)</span>
                        <span class="n">imf_mtot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kroupa_integral</span><span class="p">(</span><span class="n">imf</span><span class="o">.</span><span class="n">k1</span><span class="p">,</span> <span class="n">imf</span><span class="o">.</span><span class="n">k2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_star_m_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_star_m_max</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">)</span>
                        <span class="c1">#imf_mtot = quad(lambda m: m * imf.imf(m), self._star_m_min, self._star_m_max)[0]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logsfr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">][</span><span class="n">feh</span><span class="p">][</span><span class="s1">&#39;logsfr&#39;</span><span class="p">]</span>
                        <span class="n">imf</span> <span class="o">=</span> <span class="n">IGIMF</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">logsfr</span><span class="p">,</span> <span class="n">feh</span><span class="p">)</span>
                        <span class="n">imf</span><span class="o">.</span><span class="n">set_clusters</span><span class="p">()</span>
                        <span class="n">imf_mtot</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span> <span class="o">*</span> <span class="n">imf</span><span class="o">.</span><span class="n">imf</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_star_m_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_star_m_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">Redshift_ZAMS</span> <span class="o">==</span> <span class="n">redshift</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">FeH</span> <span class="o">==</span> <span class="n">feh</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">Mass_ZAMS1_Found</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_min</span><span class="p">)]</span>

                    <span class="k">if</span> <span class="n">mass_normalization</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invariant_imf</span><span class="p">:</span>
                            <span class="n">imf_starmass_highmass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kroupa_integral</span><span class="p">(</span><span class="n">imf</span><span class="o">.</span><span class="n">k1</span><span class="p">,</span> <span class="n">imf</span><span class="o">.</span><span class="n">k2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_min</span><span class="p">,</span>
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_max</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">imf_starmass_highmass</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span> <span class="o">*</span> <span class="n">imf</span><span class="o">.</span><span class="n">imf</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_min</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">sample_starmass_highmass</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">mass_cols</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s1">&#39;Mass_ZAMS?_Found&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mass_cols</span><span class="p">:</span>
                            <span class="n">masses</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                            <span class="n">masses</span> <span class="o">=</span> <span class="n">masses</span><span class="p">[</span><span class="n">masses</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_min</span><span class="p">]</span>
                            <span class="n">sample_starmass_highmass</span> <span class="o">+=</span> <span class="n">masses</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">imf_newnorm</span> <span class="o">=</span> <span class="n">sample_starmass_highmass</span> <span class="o">/</span> <span class="n">imf_starmass_highmass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invariant_imf</span><span class="p">:</span>
                            <span class="c1">#imf_starcount_highmass = self._kroupa_integral(imf.k1, imf.k2, self.sample_progenitor_m_min,</span>
                            <span class="c1">#                                               self.sample_progenitor_m_max, &#39;number&#39;)</span>
                            <span class="n">imf_starcount_highmass</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">imf</span><span class="o">.</span><span class="n">imf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_min</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">imf_starcount_highmass</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">imf</span><span class="o">.</span><span class="n">imf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_min</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">mass_cols</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s1">&#39;Mass_ZAMS?_Found&#39;</span><span class="p">)</span>
                        <span class="n">sample_starcount_highmass</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mass_cols</span><span class="p">:</span>
                            <span class="n">masses</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                            <span class="n">masses</span> <span class="o">=</span> <span class="n">masses</span><span class="p">[</span><span class="n">masses</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_progenitor_m_min</span><span class="p">]</span>
                            <span class="n">sample_starcount_highmass</span> <span class="o">+=</span> <span class="n">masses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">imf_newnorm</span> <span class="o">=</span> <span class="n">sample_starcount_highmass</span> <span class="o">/</span> <span class="n">imf_starcount_highmass</span>
                    <span class="n">starforming_mass</span> <span class="o">=</span> <span class="n">imf_newnorm</span> <span class="o">*</span> <span class="n">imf_mtot</span>
                    <span class="k">del</span> <span class="n">df</span>
                <span class="n">redshift_dict</span><span class="p">[</span><span class="n">feh</span><span class="p">]</span> <span class="o">=</span> <span class="n">starforming_mass</span>
                <span class="n">sample_counter</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="MergerRates.set_merger_df">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.MergerRates.set_merger_df">[docs]</a>
    <span class="k">def</span> <span class="nf">set_merger_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">merger_class</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_merger_class</span><span class="p">(</span><span class="n">merger_class</span><span class="p">)</span>
        <span class="c1">#pandarallel.initialize(progress_bar=False)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">Unbound</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span><span class="o">.</span><span class="n">Binary_Type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merger_class</span><span class="p">))]</span>
        <span class="c1"># remove systems that would not have merged by now no matter how old the progenitors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="o">.</span><span class="n">Coalescence_Time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="o">.</span><span class="n">Coalescence_Time</span> <span class="o">/</span> <span class="mf">1e9</span>  <span class="c1"># yr -&gt; Gyr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="o">.</span><span class="n">Coalescence_Time</span> <span class="o">&lt;=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">age</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
        <span class="c1"># set up the rest of the dataframe</span>
        <span class="c1">#self.merger_df[&#39;Chirp_Mass&#39;] = self.merger_df.parallel_apply(self._get_chirp_mass, axis=1)</span>
        <span class="c1">#self.merger_df[&#39;Total_Mass&#39;] = self.merger_df.parallel_apply(self._get_total_bco_mass, axis=1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="p">[</span><span class="s1">&#39;Age_Merger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_merger_age</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="p">)</span>
        <span class="c1">#self.merger_df[&#39;Age_Merger&#39;] = self.merger_df.parallel_apply(self._get_merger_age, axis=1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="p">[</span><span class="s1">&#39;Redshift_Merger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_redshift_from_age</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="o">.</span><span class="n">Age_Merger</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span></div>

        <span class="c1">#self.merger_df[&#39;Redshift_Merger&#39;] = self.merger_df.parallel_apply(</span>
        <span class="c1">#    lambda row: self._get_redshift_from_age(row.Age_Merger),</span>
        <span class="c1">#    axis=1</span>
        <span class="c1">#)</span>

    <span class="k">def</span> <span class="nf">_set_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_resolution</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span> <span class="o">=</span> <span class="n">time_resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">age</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="o">.</span><span class="n">Age_Merger</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">)</span>  <span class="c1"># Gyr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">age0</span><span class="o">+</span><span class="n">age1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">age0</span><span class="p">,</span> <span class="n">age1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_edges</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_edges</span> <span class="o">&lt;</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">age</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">(</span><span class="n">age0</span><span class="o">+</span><span class="n">age1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">age0</span><span class="p">,</span> <span class="n">age1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_full_redshift_bin_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_redshift_from_age</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_edges</span><span class="p">)</span>
        <span class="c1">#self._full_redshift_bin_edges = np.array([self._get_redshift_from_age(age) for age in self._full_age_bin_edges])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_physical_redshift_bin_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_redshift_bin_edges</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_redshift_bin_edges</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">]</span>

        <span class="n">sample_redshifts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">sample_fehs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">redshift</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">:</span>
            <span class="n">sample_redshifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>
            <span class="n">subsample_fehs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">feh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties_dict</span><span class="p">[</span><span class="n">redshift</span><span class="p">]:</span>
                <span class="n">subsample_fehs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feh</span><span class="p">)</span>
            <span class="n">subsample_fehs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">subsample_fehs</span><span class="p">)</span>
            <span class="n">sample_fehs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subsample_fehs</span><span class="p">)</span>
        <span class="n">redshift_sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sample_redshifts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_redshifts</span><span class="p">)[</span><span class="n">redshift_sorted_indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_feh_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_fehs</span><span class="p">)[</span><span class="n">redshift_sorted_indices</span><span class="p">]</span>

        <span class="n">sfrd_grid_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zams_grid_path</span><span class="p">)</span>
        <span class="n">sfrd_grid_df</span> <span class="o">=</span> <span class="n">sfrd_grid_df</span><span class="p">[[</span><span class="s1">&#39;Redshift_ZAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;FeH&#39;</span><span class="p">,</span> <span class="s1">&#39;Redshift_Bin_Edges&#39;</span><span class="p">,</span> <span class="s1">&#39;ZOH_Bin_Edges&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">redshift</span> <span class="ow">in</span> <span class="n">sfrd_grid_df</span><span class="o">.</span><span class="n">Redshift_ZAMS</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">sfrd_grid_df</span><span class="p">[</span><span class="n">sfrd_grid_df</span><span class="o">.</span><span class="n">Redshift_ZAMS</span> <span class="o">==</span> <span class="n">redshift</span><span class="p">]</span>
            <span class="n">sample_redshift_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_arr</span> <span class="o">-</span> <span class="n">redshift</span><span class="p">))</span>
            <span class="n">sample_redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_arr</span><span class="p">[</span><span class="n">sample_redshift_i</span><span class="p">]</span>
            <span class="n">sample_fehs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_feh_arr</span><span class="p">[</span><span class="n">sample_redshift_i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">feh</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">FeH</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">FeH</span> <span class="o">==</span> <span class="n">feh</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sample_feh_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sample_fehs</span> <span class="o">-</span> <span class="n">feh</span><span class="p">))</span>
                <span class="n">sample_feh</span> <span class="o">=</span> <span class="n">sample_fehs</span><span class="p">[</span><span class="n">sample_feh_i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sample_redshift</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_feh_bins_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_feh_bins_dict</span><span class="p">[</span><span class="n">sample_redshift</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_feh_bins_dict</span><span class="p">[</span><span class="n">sample_redshift</span><span class="p">][</span><span class="s1">&#39;redshift_bin_edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">Redshift_Bin_Edges</span>
                <span class="n">redshift_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_feh_bins_dict</span><span class="p">[</span><span class="n">sample_redshift</span><span class="p">]</span>
                <span class="n">feh_bin_edges</span> <span class="o">=</span> <span class="p">(</span><span class="n">ZOH_to_FeH</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ZOH_Bin_Edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ZOH_to_FeH</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ZOH_Bin_Edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">redshift_dict</span><span class="p">[</span><span class="n">sample_feh</span><span class="p">]</span> <span class="o">=</span> <span class="n">feh_bin_edges</span>

        <span class="n">min_sfrd_redshift</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_feh_bins_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_redshift_from_age</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_centers</span><span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_sfrd_redshift</span><span class="p">:</span>
            <span class="n">new_limit</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">age</span><span class="p">(</span><span class="n">min_sfrd_redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_limit</span>

    <span class="k">def</span> <span class="nf">_set_dz_dfeh_dage_mrates_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the volumetric merger rate per z_zams and [Fe/H] bin, in yr-1 Gpc-3.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dfeh_dage_mrates_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_feh_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                 <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i_redshift_zams</span><span class="p">,</span> <span class="n">redshift_zams</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_arr</span><span class="p">):</span>
            <span class="c1"># self._dz_dfeh_mrates_dict[redshift_zams] = dict()</span>
            <span class="k">for</span> <span class="n">i_feh</span><span class="p">,</span> <span class="n">feh</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_feh_arr</span><span class="p">[</span><span class="n">i_redshift_zams</span><span class="p">]):</span>
                <span class="n">starforming_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_starforming_mass_dict</span><span class="p">[</span><span class="n">redshift_zams</span><span class="p">][</span><span class="n">feh</span><span class="p">]</span>  <span class="c1"># (Mo)</span>
                <span class="n">dz_dfeh_merger_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="o">.</span><span class="n">Redshift_ZAMS</span> <span class="o">==</span> <span class="n">redshift_zams</span><span class="p">)</span> <span class="o">&amp;</span>
                                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merger_df</span><span class="o">.</span><span class="n">FeH</span> <span class="o">==</span> <span class="n">feh</span><span class="p">)]</span>
                <span class="n">dz_dfeh_merger_age_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dz_dfeh_merger_df</span><span class="o">.</span><span class="n">Age_Merger</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>  <span class="c1"># (Gyr)</span>

                <span class="n">age_bin_heights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bin_frequency_heights</span><span class="p">(</span><span class="n">x_arr</span><span class="o">=</span><span class="n">dz_dfeh_merger_age_arr</span><span class="p">,</span>  <span class="c1"># dN/dt (Gyr-1)</span>
                                                                  <span class="n">x_bin_edges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_edges</span><span class="p">)</span>
                <span class="n">age_bin_heights</span> <span class="o">/=</span> <span class="n">starforming_mass</span>  <span class="c1"># dN/dt dMsf (Gyr-1  Mo-1)</span>
                <span class="n">age_bin_heights</span> <span class="o">*=</span> <span class="mf">1e9</span>  <span class="c1"># dN/dt dMsf (yr-1 Mo-1)</span>

                <span class="n">log_sfrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfrd</span><span class="o">.</span><span class="n">get_logsfrd</span><span class="p">(</span><span class="n">feh</span><span class="p">,</span> <span class="n">redshift_zams</span><span class="p">)</span>  <span class="c1"># log10(dMsf/dVc dz_zams dFeH)</span>
                                                                      <span class="c1"># ~log10(dMsf/dt dVc dz_zams dFeH)~</span>
                                                                      <span class="c1"># log10(Mo Mpc-3)</span>
                                                                      <span class="c1"># ~(log(Mo Myr-1 Mpc-3))~</span>
                <span class="n">age_bin_sfmass_density</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_sfrd</span> <span class="o">/</span> <span class="mf">1e9</span> <span class="c1"># dMsf/dVc dz_zams dFeH (Mo Gpc-3)</span>
                                            <span class="c1"># dMsf/dVc dz_zams dFeH(Mo Gpc-3)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_time</span><span class="p">:</span>
                    <span class="c1"># convert time from the source (in which the SFR is measured) to the observer frame (in which the</span>
                    <span class="c1"># merger rate is measured), dt_s/dt_o = 1 / 1+z, and SFRD = dM_sf/dt_s dVc</span>
                    <span class="n">age_bin_heights</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">redshift_zams</span>
                <span class="c1">#age_bin_sfmass_densities = sfrd * self._full_age_bin_widths  # dMsf/dVc dz_zams dFeH (Mo Gpc-3)</span>
                <span class="n">age_bin_heights</span> <span class="o">*=</span> <span class="n">age_bin_sfmass_density</span>  <span class="c1"># dN/dt dVc dz_zams dFeH (yr-1 Gpc-3)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_method</span><span class="p">:</span>
                    <span class="n">delta_z_zams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_feh_bins_dict</span><span class="p">[</span><span class="n">redshift_zams</span><span class="p">][</span><span class="s1">&#39;redshift_bin_edges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_feh_bins_dict</span><span class="p">[</span><span class="n">redshift_zams</span><span class="p">][</span><span class="s1">&#39;redshift_bin_edges&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">delta_feh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_feh_bins_dict</span><span class="p">[</span><span class="n">redshift_zams</span><span class="p">][</span><span class="n">feh</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_feh_bins_dict</span><span class="p">[</span><span class="n">redshift_zams</span><span class="p">][</span><span class="n">feh</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">age_bin_heights</span> <span class="o">/=</span> <span class="n">delta_z_zams</span> <span class="o">*</span> <span class="n">delta_feh</span>  <span class="c1"># dN/dt dVc delta_z_zams delta FeH (yr-1 Gpc-3)</span>

                <span class="c1"># self._dz_dfeh_mrates_dict[redshift_zams][feh] = age_bin_heights</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dfeh_dage_mrates_arr</span><span class="p">[</span><span class="n">i_redshift_zams</span><span class="p">,</span> <span class="n">i_feh</span><span class="p">]</span> <span class="o">=</span> <span class="n">age_bin_heights</span>

    <span class="k">def</span> <span class="nf">_get_feh_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We reorder the array columns to the order we must access them in for fitting over [Fe/H].</span>
        <span class="n">dage_dz_dfeh_mrates_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dz_dfeh_dage_mrates_arr</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">max_fehs_per_redshift</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_feh_arr</span><span class="p">])</span>
        <span class="n">per_age_redshift_feh_fits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_widths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">max_fehs_per_redshift</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                                              <span class="mi">4</span><span class="p">),</span>
                                             <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i_age</span><span class="p">,</span> <span class="n">dz_dfeh_mrates_arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dage_dz_dfeh_mrates_arr</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i_redshift</span><span class="p">,</span> <span class="n">dfeh_mrates_arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dz_dfeh_mrates_arr</span><span class="p">):</span>
                <span class="n">feh_mrate0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">min_feh</span><span class="p">,</span>
                              <span class="mf">0.0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i_feh</span><span class="p">,</span> <span class="n">mrate1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfeh_mrates_arr</span><span class="p">):</span>
                    <span class="n">feh_mrate1</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_feh_arr</span><span class="p">[</span><span class="n">i_redshift</span><span class="p">,</span> <span class="n">i_feh</span><span class="p">],</span>
                                  <span class="n">mrate1</span><span class="p">]</span>
                    <span class="n">per_age_redshift_feh_fits</span><span class="p">[</span><span class="n">i_age</span><span class="p">,</span> <span class="n">i_redshift</span><span class="p">,</span> <span class="n">i_feh</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linear_fit</span><span class="p">(</span><span class="n">feh_mrate0</span><span class="p">,</span> <span class="n">feh_mrate1</span><span class="p">)</span>
                    <span class="n">feh_mrate0</span> <span class="o">=</span> <span class="n">feh_mrate1</span>
                <span class="n">feh_mrate1</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_feh</span><span class="p">,</span>
                              <span class="mf">0.0</span><span class="p">]</span>
                <span class="n">per_age_redshift_feh_fits</span><span class="p">[</span><span class="n">i_age</span><span class="p">,</span> <span class="n">i_redshift</span><span class="p">,</span> <span class="n">i_feh</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linear_fit</span><span class="p">(</span><span class="n">feh_mrate0</span><span class="p">,</span> <span class="n">feh_mrate1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">per_age_redshift_feh_fits</span>

    <span class="k">def</span> <span class="nf">_get_boundary_fit_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">boundary</span><span class="p">):</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">fit</span>
        <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;feh&#39;</span><span class="p">:</span>
            <span class="n">min_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_feh</span>
            <span class="n">max_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_feh</span>
        <span class="k">elif</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;redshift&#39;</span><span class="p">:</span>
            <span class="n">min_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_redshift</span>
            <span class="n">max_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_redshift</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Variable should be &quot;feh&quot; or &quot;redshift&quot;, but </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1"> was passed.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slope</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x_intercept</span> <span class="o">=</span> <span class="o">-</span><span class="n">intercept</span> <span class="o">/</span> <span class="n">slope</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_intercept</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">boundary</span> <span class="o">==</span> <span class="s1">&#39;lower&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x_intercept</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">slope</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">var_mrate0</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_var</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">var_mrate1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span>
                <span class="n">boundary_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linear_fit</span><span class="p">(</span><span class="n">var_mrate0</span><span class="p">,</span> <span class="n">var_mrate1</span><span class="p">)</span>
                <span class="n">fixed_fit_edge</span> <span class="o">=</span> <span class="n">x0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boundary_fit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">fixed_fit_edge</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">min_var</span><span class="p">,</span> <span class="n">x_intercept</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">boundary</span> <span class="o">==</span> <span class="s1">&#39;upper&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x_intercept</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">slope</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">var_mrate0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span>
                <span class="n">var_mrate1</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_var</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">boundary_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linear_fit</span><span class="p">(</span><span class="n">var_mrate0</span><span class="p">,</span> <span class="n">var_mrate1</span><span class="p">)</span>
                <span class="n">fixed_fit_edge</span> <span class="o">=</span> <span class="n">x1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boundary_fit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">fixed_fit_edge</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">max_var</span><span class="p">,</span> <span class="n">x_intercept</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Boundary parameter must be one of [&quot;lower&quot;,&quot;upper&quot;], not </span><span class="si">{</span><span class="n">boundary</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">boundary_fit</span><span class="p">,</span> <span class="n">fixed_fit_edge</span>

    <span class="k">def</span> <span class="nf">_set_dz_dage_mrates_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the volumetric merger rate per z_zams bin, integrated over [Fe/H], in yr-1 Gpc-3.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_per_age_redshift_feh_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_feh_fits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dage_mrates_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_per_age_redshift_feh_fits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">_per_age_redshift_feh_fits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i_age</span><span class="p">,</span> <span class="n">per_redshift_feh_fits</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_per_age_redshift_feh_fits</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i_redshift</span><span class="p">,</span> <span class="n">per_feh_fits</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">per_redshift_feh_fits</span><span class="p">):</span>
                <span class="n">per_redshift_age_mrate</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i_feh</span><span class="p">,</span> <span class="n">fit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">per_feh_fits</span><span class="p">):</span>
                    <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">fit</span>

                    <span class="k">if</span> <span class="n">i_feh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">boundary_fit</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_boundary_fit_limit</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;feh&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i_feh</span> <span class="o">==</span> <span class="n">per_feh_fits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">boundary_fit</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_boundary_fit_limit</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;feh&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">boundary_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

                    <span class="n">mrate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linear_fit_area</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">))</span>
                    <span class="n">boundary_mrate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linear_fit_area</span><span class="p">(</span><span class="n">boundary_fit</span><span class="p">)</span>
                    <span class="n">per_redshift_age_mrate</span> <span class="o">+=</span> <span class="n">mrate</span> <span class="o">+</span> <span class="n">boundary_mrate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dage_mrates_arr</span><span class="p">[</span><span class="n">i_redshift</span><span class="p">,</span> <span class="n">i_age</span><span class="p">]</span> <span class="o">=</span> <span class="n">per_redshift_age_mrate</span>

    <span class="k">def</span> <span class="nf">_set_dz_dpopage_mrates_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dpopage_mrates_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dz_dage_mrates_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i_redshift</span><span class="p">,</span> <span class="n">dage_mrates_arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dz_dage_mrates_arr</span><span class="p">):</span>
            <span class="n">start_i</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dage_mrates_arr</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">nonzero_dage_mrates_arr</span> <span class="o">=</span> <span class="n">dage_mrates_arr</span><span class="p">[</span><span class="n">start_i</span><span class="p">:]</span>
            <span class="n">dpopage_mrates_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
                <span class="n">nonzero_dage_mrates_arr</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">nonzero_dage_mrates_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dpopage_mrates_arr</span><span class="p">[</span><span class="n">i_redshift</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpopage_mrates_arr</span>

    <span class="k">def</span> <span class="nf">_set_ip_dz_dpopage_mrates_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip_redshift_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_redshift_from_age</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_centers</span><span class="p">)</span>
        <span class="c1">#self.ip_redshift_arr = np.array([self._get_redshift_from_age(age) for age in self._physical_age_bin_centers])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_dz_dpopage_mrates_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_redshift_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dpopage_mrates_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

        <span class="n">dpopage_dz_mrates_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dz_dpopage_mrates_arr</span><span class="o">.</span><span class="n">T</span>
        <span class="n">ip_dpopage_dz_mrates_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ip_dz_dpopage_mrates_arr</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">i_age</span><span class="p">,</span> <span class="n">dz_mrates_arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dpopage_dz_mrates_arr</span><span class="p">):</span>
            <span class="n">interpolator</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_redshift_arr</span><span class="p">,</span> <span class="n">dz_mrates_arr</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
            <span class="n">ip_dpopage_dz_mrates_arr</span><span class="p">[</span><span class="n">i_age</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_redshift_arr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_dz_dpopage_mrates_arr</span> <span class="o">=</span> <span class="n">ip_dpopage_dz_mrates_arr</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">_set_ip_dz_dage_mrates_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ip_dz_dage_mrates_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_dz_dpopage_mrates_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ip_redshift_i</span><span class="p">,</span> <span class="n">dpopage_mrates_arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ip_dz_dpopage_mrates_arr</span><span class="p">):</span>
            <span class="n">redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_redshift_arr</span><span class="p">[</span><span class="n">ip_redshift_i</span><span class="p">]</span>
            <span class="n">first_physical_redshift_bin_edge_i</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_redshift_bin_edges</span><span class="p">)</span>
                                                       <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">redshift</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">first_physical_redshift_bin_edge_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">last_physical_age_bin_edge_i</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last_physical_age_bin_edge_i</span> <span class="o">=</span> <span class="o">-</span><span class="n">first_physical_redshift_bin_edge_i</span>
            <span class="n">dage_mrates_arr</span> <span class="o">=</span> <span class="n">dpopage_mrates_arr</span><span class="p">[:</span><span class="n">last_physical_age_bin_edge_i</span><span class="p">]</span>
            <span class="n">dage_mrates_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_age_bin_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dage_mrates_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                       <span class="n">dage_mrates_arr</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ip_dz_dage_mrates_arr</span><span class="p">[</span><span class="n">ip_redshift_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dage_mrates_arr</span>

    <span class="k">def</span> <span class="nf">_get_z_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ip_dage_dz_mrates_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ip_dz_dage_mrates_arr</span><span class="o">.</span><span class="n">T</span>
        <span class="n">per_age_redshift_fits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">ip_redshift_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                                          <span class="mi">4</span><span class="p">),</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i_age</span><span class="p">,</span> <span class="n">dz_mrates_arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ip_dage_dz_mrates_arr</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i_age</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_physical_age_bin_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="n">z_mrate0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_redshift</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i_z</span><span class="p">,</span> <span class="n">mrate1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dz_mrates_arr</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i_z</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_redshift_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="n">z_mrate1</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_redshift_arr</span><span class="p">[</span><span class="n">i_z</span><span class="p">],</span>
                            <span class="n">mrate1</span><span class="p">]</span>
                <span class="n">per_age_redshift_fits</span><span class="p">[</span><span class="n">i_age</span><span class="p">,</span> <span class="n">i_z</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linear_fit</span><span class="p">(</span><span class="n">z_mrate0</span><span class="p">,</span> <span class="n">z_mrate1</span><span class="p">)</span>
                <span class="n">z_mrate0</span> <span class="o">=</span> <span class="n">z_mrate1</span>
            <span class="n">z_mrate1</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">min_redshift</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">]</span>
            <span class="n">per_age_redshift_fits</span><span class="p">[</span><span class="n">i_age</span><span class="p">,</span> <span class="n">i_z</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linear_fit</span><span class="p">(</span><span class="n">z_mrate0</span><span class="p">,</span> <span class="n">z_mrate1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">per_age_redshift_fits</span>

    <span class="k">def</span> <span class="nf">_set_dage_mrates_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Get the volumetric merger rate, integrated over z_zams and [Fe/H], in yr-1 Gpc-3.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_per_age_redshift_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_z_fits</span><span class="p">()</span>
        <span class="n">dage_mrates_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_per_age_redshift_fits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i_age</span><span class="p">,</span> <span class="n">per_redshift_fits</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_per_age_redshift_fits</span><span class="p">):</span>
            <span class="n">per_age_mrate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i_z</span><span class="p">,</span> <span class="n">fit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">per_redshift_fits</span><span class="p">):</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">fit</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">i_z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">boundary_fit</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_boundary_fit_limit</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;redshift&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i_z</span> <span class="o">==</span> <span class="n">per_redshift_fits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">boundary_fit</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_boundary_fit_limit</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;redshift&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">boundary_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

                <span class="n">mrate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linear_fit_area</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">))</span>
                <span class="n">boundary_mrate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_linear_fit_area</span><span class="p">(</span><span class="n">boundary_fit</span><span class="p">)</span>
                <span class="n">per_age_mrate</span> <span class="o">+=</span> <span class="n">mrate</span> <span class="o">+</span> <span class="n">boundary_mrate</span>
            <span class="n">dage_mrates_arr</span><span class="p">[</span><span class="n">i_age</span><span class="p">]</span> <span class="o">=</span> <span class="n">per_age_mrate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mrate_arr</span> <span class="o">=</span> <span class="n">dage_mrates_arr</span>

<div class="viewcode-block" id="MergerRates.delete_sample_df_from_memory">
<a class="viewcode-back" href="../../bossa.html#bossa.postprocessing.MergerRates.delete_sample_df_from_memory">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_sample_df_from_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Lucas de Sá.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>